<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nepali Calendar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .calendar-container {
            max-width: 1200px;
            margin: 20px auto;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #ddd;
        }
        .calendar-day {
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            min-height: 100px;
            position: relative;
            cursor: pointer;
        }
        .calendar-day:hover {
            background-color: #f1f1f1;
        }
        .calendar-day:focus {
            outline: 2px solid #007bff;
        }
        .calendar-day.today {
            background-color: #e7f3ff;
            border: 2px solid #007bff;
            animation: blink 1.5s infinite; /* Add blinking animation */
        }
        @keyframes blink {
            0% { background-color: #e7f3ff; }
            50% { background-color: #b3d7ff; }
            100% { background-color: #e7f3ff; }
        }
        .calendar-day.saturday {
            background-color: #ffcccc; /* Red background for Saturdays */
        }
        .calendar-day.holiday, .calendar-day.custom-holiday {
            background-color: #ffe6e6;
        }
        .bs-date {
            font-size: 1.2em;
            font-weight: bold;
        }
        .greg-date {
            font-size: 0.9em;
            color: #666;
        }
        .festival {
            font-size: 0.8em;
            color: #d32f2f;
            margin-top: 5px;
        }
        .festival-tooltip, .note-tooltip, .finance-tooltip {
            display: none;
            position: absolute;
            background-color: #333;
            color: #fff;
            padding: 5px;
            border-radius: 3px;
            font-size: 0.8em;
            z-index: 1000;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
        }
        .calendar-day:hover .festival-tooltip,
        .calendar-day:hover .note-tooltip,
        .calendar-day:hover .finance-tooltip {
            display: block;
        }
        .note-indicator, .income-indicator, .expense-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: absolute;
            top: 5px;
            right: 5px;
        }
        .note-indicator {
            background-color: #007bff;
        }
        .income-indicator {
            background-color: #28a745;
        }
        .expense-indicator {
            background-color: #dc3545;
        }
        .event-preview {
            font-size: 0.8em;
            margin-top: 5px;
            color: #333;
        }
        .month-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
        }
        .month-tabs .btn {
            flex: 1 1 auto;
        }
        .nepali {
            font-family: 'Preeti', 'Kalimati', sans-serif;
        }
        #holidayList {
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="calendar-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 data-en="Nepali Calendar" data-ne="नेपाली पात्रो">Nepali Calendar</h1>
            <div>
                <select id="yearFilter" class="form-select d-inline-block w-auto">
                    <option value="2081">2081 BS</option>
                    <option value="2082">2082 BS</option>
                    <option value="2083">2083 BS</option>
                </select>
                <button id="todayButton" class="btn btn-primary ms-2" data-en="Today" data-ne="आज">Today</button>
                <button id="languageToggle" class="btn btn-secondary ms-2" data-en="Switch to Nepali" data-ne="Switch to English">Switch to Nepali</button>
            </div>
        </div>
        <div class="d-flex justify-content-between mb-3">
            <div>
                <button id="addNote" class="btn btn-success me-2" data-en="Add Note" data-ne="नोट थप्नुहोस्">Add Note</button>
                <button id="addFinance" class="btn btn-info me-2" data-en="Add Finance" data-ne="वित्त थप्नुहोस्">Add Finance</button>
                <button id="viewNotes" class="btn btn-primary me-2" data-en="View Notes" data-ne="नोटहरू हेर्नुहोस्">View Notes</button>
                <button id="viewFinance" class="btn btn-warning me-2" data-en="View Finance" data-ne="वित्त हेर्नुहोस्">View Finance</button>
                <button id="undoAction" class="btn btn-secondary me-2" data-en="Undo" data-ne="पूर्ववत् गर्नुहोस्">Undo</button>
                <button id="addCustomHoliday" class="btn btn-danger me-2" data-en="Add Custom Holiday" data-ne="कस्टम बिदा थप्नुहोस्">Add Custom Holiday</button>
                <button id="manageShoppingList" class="btn btn-info" data-en="Manage Shopping List" data-ne="किनमेल सूची व्यवस्थापन गर्नुहोस्">Manage Shopping List</button>
            </div>
            <div class="d-flex">
                <div class="dropdown me-2">
                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-en="Export Data" data-ne="डाटा निर्यात गर्नुहोस्">Export Data</button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item excel-option" href="#" data-type="note" data-en="Export Notes (Excel)" data-ne="नोटहरू निर्यात गर्नुहोस् (Excel)">Export Notes (Excel)</a></li>
                        <li><a class="dropdown-item excel-option" href="#" data-type="finance" data-en="Export Finances (Excel)" data-ne="वित्त निर्यात गर्नुहोस् (Excel)">Export Finances (Excel)</a></li>
                        <li><a class="dropdown-item excel-option" href="#" data-type="calendar" data-en="Export Calendar (Excel)" data-ne="पात्रो निर्यात गर्नुहोस् (Excel)">Export Calendar (Excel)</a></li>
                        <li><a class="dropdown-item excel-option" href="#" data-type="holiday" data-en="Export Holidays (Excel)" data-ne="बिदाहरू निर्यात गर्नुहोस् (Excel)">Export Holidays (Excel)</a></li>
                        <li><a class="dropdown-item pdf-option" href="#" data-type="note" data-en="Export Notes (PDF)" data-ne="नोटहरू निर्यात गर्नुहोस् (PDF)">Export Notes (PDF)</a></li>
                        <li><a class="dropdown-item pdf-option" href="#" data-type="finance" data-en="Export Finances (PDF)" data-ne="वित्त निर्यात गर्नुहोस् (PDF)">Export Finances (PDF)</a></li>
                        <li><a class="dropdown-item pdf-option" href="#" data-type="calendar" data-en="Export Calendar (PDF)" data-ne="पात्रो निर्यात गर्नुहोस् (PDF)">Export Calendar (PDF)</a></li>
                        <li><a class="dropdown-item" id="backupData" href="#" data-en="Backup Data" data-ne="डाटा ब्याकअप गर्नुहोस्">Backup Data</a></li>
                        <li><a class="dropdown-item" id="restoreData" href="#" data-en="Restore Data" data-ne="डाटा पुनर्स्थापना गर्नुहोस्">Restore Data</a></li>
                    </ul>
                    <input type="file" id="restoreFileInput" style="display: none;" accept=".json">
                </div>
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-en="Import Data" data-ne="डाटा आयात गर्नुहोस्">Import Data</button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item import-option" href="#" data-type="note" data-en="Import Notes" data-ne="नोटहरू आयात गर्नुहोस्">Import Notes</a></li>
                        <li><a class="dropdown-item import-option" href="#" data-type="finance" data-en="Import Finances" data-ne="वित्त आयात गर्नुहोस्">Import Finances</a></li>
                        <li><a class="dropdown-item import-option" href="#" data-type="calendar" data-en="Import Calendar" data-ne="पात्रो आयात गर्नुहोस्">Import Calendar</a></li>
                        <li><a class="dropdown-item import-option" href="#" data-type="holiday" data-en="Import Holidays" data-ne="बिदाहरू आयात गर्नुहोस्">Import Holidays</a></li>
                    </ul>
                    <input type="file" id="importFileInput" style="display: none;" accept=".json,.xlsx">
                </div>
            </div>
        </div>
        <div class="month-tabs" id="monthTabs" role="tablist"></div>
        <h2 id="currentMonth" class="text-center mb-3"></h2>
        <div class="calendar-grid" id="calendarGrid" role="grid"></div>
        <div class="row mt-3">
            <div class="col-md-4">
                <h4 data-en="Today's Date" data-ne="आजको मिति">Today's Date</h4>
                <p><strong data-en="Nepali:" data-ne="नेपाली:">Nepali:</strong> <span id="todayNepaliDate"></span></p>
                <p><strong data-en="English:" data-ne="अंग्रेजी:">English:</strong> <span id="todayEnglishDate"></span></p>
            </div>
            <div class="col-md-4">
                <h4 data-en="Monthly Summary" data-ne="मासिक सारांश">Monthly Summary</h4>
                <div id="monthlySummary"></div>
            </div>
            <div class="col-md-4">
                <h4 data-en="Holidays This Month" data-ne="यस महिनाका बिदाहरू">Holidays This Month</h4>
                <ul id="holidayList" class="list-group"></ul>
            </div>
        </div>
    </div>

    <!-- Note/Finance Modal -->
    <div class="modal fade" id="noteFormModal" tabindex="-1" aria-labelledby="noteFormModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="noteFormModalLabel" data-en="Add Entry" data-ne="प्रविष्टि थप्नुहोस्">Add Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="selectedDate" class="form-label" data-en="Date" data-ne="मिति">Date</label>
                        <input type="date" class="form-control" id="selectedDate">
                    </div>
                    <div class="mb-3">
                        <label for="entryType" class="form-label" data-en="Type" data-ne="प्रकार">Type</label>
                        <select id="entryType" class="form-select">
                            <option value="note" data-en="Note" data-ne="नोट">Note</option>
                            <option value="income" data-en="Income" data-ne="आय">Income</option>
                            <option value="expense" data-en="Expense" data-ne="खर्च">Expense</option>
                            <option value="budget" data-en="Budget" data-ne="बजेट">Budget</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="noteTitle" class="form-label" data-en="Amount / Title" data-ne="रकम / शीर्षक">Amount / Title</label>
                        <input type="text" class="form-control" id="noteTitle">
                    </div>
                    <div class="mb-3">
                        <label for="noteTime" class="form-label" data-en="Time (Optional)" data-ne="समय (वैकल्पिक)">Time (Optional)</label>
                        <input type="time" class="form-control" id="noteTime">
                    </div>
                    <div class="mb-3">
                        <label for="noteDescription" class="form-label" data-en="Description (Optional)" data-ne="विवरण (वैकल्पिक)">Description (Optional)</label>
                        <textarea class="form-control" id="noteDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3" id="entryCategory" style="display: none;">
                        <label for="category" class="form-label" data-en="Category" data-ne="श्रेणी">Category</label>
                        <select class="form-select" id="category">
                            <option value="Food" data-en="Food" data-ne="खाना">Food</option>
                            <option value="Transport" data-en="Transport" data-ne="यातायात">Transport</option>
                            <option value="Entertainment" data-en="Entertainment" data-ne="मनोरञ्जन">Entertainment</option>
                            <option value="Health" data-en="Health" data-ne="स्वास्थ्य">Health</option>
                            <option value="Other" data-en="Other" data-ne="अन्य">Other</option>
                        </select>
                    </div>
                    <div class="mb-3" id="categoryManager" style="display: none;">
                        <label for="newCategory" class="form-label" data-en="Add New Category" data-ne="नयाँ श्रेणी थप्नुहोस्">Add New Category</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newCategory">
                            <button class="btn btn-outline-secondary" id="addCategory" data-en="Add" data-ne="थप्नुहोस्">Add</button>
                        </div>
                    </div>
                    <div class="mb-3" id="budgetSection" style="display: none;">
                        <label for="monthlyBudget" class="form-label" data-en="Monthly Budget" data-ne="मासिक बजेट">Monthly Budget</label>
                        <input type="number" class="form-control" id="monthlyBudget">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="recurring">
                        <label class="form-check-label" for="recurring" data-en="Recurring" data-ne="मासिक">Recurring</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="reminder">
                        <label class="form-check-label" for="reminder" data-en="Set Reminder" data-ne="रिमाइन्डर सेट गर्नुहोस्">Set Reminder</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="closeEntry" data-bs-dismiss="modal" data-en="Close" data-ne="बन्द गर्नुहोस्">Close</button>
                    <button type="button" class="btn btn-primary" id="saveNote" data-en="Save" data-ne="सुरक्षित गर्नुहोस्">Save</button>
                    <button type="button" class="btn btn-primary" id="editEntry" style="display: none;" data-en="Update" data-ne="अपडेट गर्नुहोस्">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="notesModalLabel" data-en="Notes" data-ne="नोटहरू">Notes</h5>
                    <button type="button" class="btn-close" id="closeModal" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="noteSearch" class="form-label" data-en="Search Notes" data-ne="नोटहरू खोज्नुहोस्">Search Notes</label>
                    <input type="text" class="form-control" id="noteSearch" placeholder="Search by title">
                    </div>
                    <div class="mb-3">
                        <label for="monthFilter" class="form-label" data-en="Filter by Month" data-ne="महिनाद्वारा फिल्टर गर्नुहोस्">Filter by Month</label>
                        <select id="monthFilter" class="form-select">
                            <option value="">All Months</option>
                        </select>
                    </div>
                    <ul id="notesList" class="list-group"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="clearNotes" data-en="Clear All Notes" data-ne="सबै नोटहरू खाली गर्नुहोस्">Clear All Notes</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-en="Close" data-ne="बन्द गर्नुहोस्">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="reportModalLabel" data-en="Financial Reports" data-ne="वित्तीय रिपोर्टहरू">Financial Reports</h5>
                    <button type="button" class="btn-close" id="closeReportModal" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3">
                        <li class="nav-item">
                            <a class="nav-link active" id="weeklyReportTab" href="#" data-en="Weekly" data-ne="साप्ताहिक">Weekly</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="monthlyReportTab" href="#" data-en="Monthly" data-ne="मासिक">Monthly</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="yearlyReportTab" href="#" data-en="Yearly" data-ne="वार्षिक">Yearly</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="recordsReportTab" href="#" data-en="Records" data-ne="रेकर्डहरू">Records</a>
                        </li>
                    </ul>
                    <div class="mb-3">
                        <label for="financeSearch" class="form-label" data-en="Search Finances" data-ne="वित्त खोज्नुहोस्">Search Finances</label>
                        <input type="text" class="form-control" id="financeSearch" placeholder="Search by title or category">
                    </div>
                    <div id="reportContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-en="Close" data-ne="बन्द गर्नुहोस्">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Holiday Modal -->
    <div class="modal fade" id="customHolidayModal" tabindex="-1" aria-labelledby="customHolidayModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customHolidayModalLabel" data-en="Add Custom Holiday" data-ne="कस्टम बिदा थप्नुहोस्">Add Custom Holiday</h5>
                    <button type="button" class="btn-close" id="closeCustomHolidayModal" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="holidayDate" class="form-label" data-en="Date" data-ne="मिति">Date</label>
                        <input type="date" class="form-control" id="holidayDate">
                    </div>
                    <div class="mb-3">
                        <label for="holidayName" class="form-label" data-en="Holiday Name (English)" data-ne="बिदाको नाम (अंग्रेजी)">Holiday Name (English)</label>
                        <input type="text" class="form-control" id="holidayName">
                    </div>
                    <div class="mb-3">
                        <label for="holidayNepaliName" class="form-label" data-en="Holiday Name (Nepali)" data-ne="बिदाको नाम (नेपाली)">Holiday Name (Nepali)</label>
                        <input type="text" class="form-control" id="holidayNepaliName">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="closeCustomHolidayModal" data-bs-dismiss="modal" data-en="Close" data-ne="बन्द गर्नुहोस्">Close</button>
                    <button type="button" class="btn btn-primary" id="saveCustomHoliday" data-en="Save" data-ne="सुरक्षित गर्नुहोस्">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shopping List Modal -->
    <div class="modal fade" id="shoppingListModal" tabindex="-1" aria-labelledby="shoppingListModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="shoppingListModalLabel" data-en="Shopping List" data-ne="किनमेल सूची">Shopping List</h5>
                    <button type="button" class="btn-close" id="closeShoppingListModal" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newShoppingItem" class="form-label" data-en="New Item" data-ne="नयाँ सामान">New Item</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="newShoppingItem">
                            <button class="btn btn-outline-secondary" id="addShoppingItem" data-en="Add" data-ne="थप्नुहोस्">Add</button>
                        </div>
                    </div>
                    <ul id="shoppingItemsList" class="list-group"></ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" id="clearShoppingList" data-en="Clear List" data-ne="सूची खाली गर्नुहोस्">Clear List</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-en="Close" data-ne="बन्द गर्नुहोस्">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script nonce="OGY1ZmVhYWEtOGRlNy00YjRhLTk4NzEtNjY2OWU2MGNiN2Y2">
        // Calendar data
        const calendarData = {
            2081: [
                {name:"Baishakh",days:31,gregStart:"2024-04-13"},
                {name:"Jestha",days:32,gregStart:"2024-05-14"},
                {name:"Ashadh",days:31,gregStart:"2024-06-15"},
                {name:"Shrawan",days:32,gregStart:"2024-07-16"},
                {name:"Bhadra",days:31,gregStart:"2024-08-17"},
                {name:"Asoj",days:31,gregStart:"2024-09-17"},
                {name:"Kartik",days:30,gregStart:"2024-10-18"},
                {name:"Mangsir",days:29,gregStart:"2024-11-17"},
                {name:"Poush",days:30,gregStart:"2024-12-16"},
                {name:"Magh",days:29,gregStart:"2025-01-15"},
                {name:"Falgun",days:30,gregStart:"2025-02-13"},
                {name:"Chaitra",days:30,gregStart:"2025-03-15"}
            ],
            2082: [
                {name:"Baishakh",days:31,gregStart:"2025-04-14"},
                {name:"Jestha",days:31,gregStart:"2025-05-15"},
                {name:"Ashadh",days:32,gregStart:"2025-06-15"},
                {name:"Shrawan",days:31,gregStart:"2025-07-17"},
                {name:"Bhadra",days:31,gregStart:"2025-08-17"},
                {name:"Asoj",days:31,gregStart:"2025-09-17"},
                {name:"Kartik",days:30,gregStart:"2025-10-18"},
                {name:"Mangsir",days:29,gregStart:"2025-11-17"},
                {name:"Poush",days:30,gregStart:"2025-12-16"},
                {name:"Magh",days:29,gregStart:"2026-01-15"},
                {name:"Falgun",days:30,gregStart:"2026-02-13"},
                {name:"Chaitra",days:31,gregStart:"2026-03-15"}
            ],
            2083: [
                {name:"Baishakh",days:31,gregStart:"2026-04-14"},
                {name:"Jestha",days:32,gregStart:"2026-05-15"},
                {name:"Ashadh",days:31,gregStart:"2026-06-16"},
                {name:"Shrawan",days:31,gregStart:"2026-07-17"},
                {name:"Bhadra",days:31,gregStart:"2026-08-17"},
                {name:"Asoj",days:30,gregStart:"2026-09-17"},
                {name:"Kartik",days:30,gregStart:"2026-10-17"},
                {name:"Mangsir",days:30,gregStart:"2026-11-16"},
                {name:"Poush",days:29,gregStart:"2026-12-16"},
                {name:"Magh",days:30,gregStart:"2027-01-14"},
                {name:"Falgun",days:30,gregStart:"2027-02-13"},
                {name:"Chaitra",days:31,gregStart:"2027-03-15"}
            ]
        };

        // Holidays data
        const holidays = {
            2081: [
                { month: 6, day: 1, name: "Dashain", nepali: "दशैं", type: "holiday" },
                { month: 6, day: 15, name: "Tihar", nepali: "तिहार", type: "holiday" },
                { month: 11, day: 1, name: "Chaitra Navaratri", nepali: "चैत्र नवरात्री", type: "holiday" }
            ],
            2082: [
                { month: 0, day: 1, name: "Nepali New Year", nepali: "नेपाली नयाँ वर्ष", type: "holiday" },
                { month: 0, day: 5, name: "Ram Navami", nepali: "राम नवमी", type: "holiday" },
                { month: 0, day: 29, name: "Ubauli Parva", nepali: "उबौली पर्व", type: "holiday" },
                { month: 0, day: 29, name: "Buddha Jayanti", nepali: "बुद्ध जयन्ती", type: "holiday" },
                { month: 0, day: 18, name: "May Day Labour Day", nepali: "मे दिवस", type: "holiday" },
                { month: 1, day: 15, name: "Republic Day", nepali: "गणतन्त्र दिवस", type: "holiday" },
                { month: 3, day: 24, name: "Rakshya Bandhan", nepali: "रक्षा बन्धन", type: "holiday" },
                { month: 3, day: 25, name: "Gai Jatra", nepali: "गाईजात्रा", type: "holiday" },
                { month: 3, day: 25, name: "Gaijatra", nepali: "गाईजात्रा", type: "holiday" },
                { month: 3, day: 31, name: "Krishna Janmashtami", nepali: "कृष्ण जन्माष्टमी", type: "holiday" },
                { month: 4, day: 10, name: "Haritalika (Teej)", nepali: "हरितालिका (तीज)", type: "holiday" },
                { month: 4, day: 15, name: "Gaura Parva", nepali: "गौरा पर्व", type: "holiday" },
                { month: 4, day: 21, name: "Indra Jatra", nepali: "इन्द्रजात्रा", type: "holiday" },
                { month: 4, day: 30, name: "Jitiya Festival", nepali: "जितिया पर्व", type: "holiday" },
                { month: 5, day: 3, name: "Constitution Day", nepali: "संविधान दिवस", type: "holiday" },
                { month: 5, day: 6, name: "Ghatasthapana", nepali: "घटस्थापना", type: "holiday" },
                { month: 5, day: 13, name: "Dashain", nepali: "दशैं", type: "holiday" },
                { month: 5, day: 14, name: "Dashain", nepali: "दशैं", type: "holiday" },
                { month: 5, day: 15, name: "Dashain", nepali: "दशैं", type: "holiday" },
                { month: 5, day: 16, name: "Dashain", nepali: "दशैं", type: "holiday" },
                { month: 5, day: 17, name: "Dashain", nepali: "दशैं", type: "holiday" },
                { month: 5, day: 18, name: "Dashain", nepali: "दशैं", type: "holiday" },
                { month: 6, day: 3, name: "Tihar", nepali: "तिहार", type: "holiday" },
                { month: 6, day: 4, name: "Tihar", nepali: "तिहार", type: "holiday" },
                { month: 6, day: 5, name: "Tihar", nepali: "तिहार", type: "holiday" },
                { month: 6, day: 6, name: "Tihar", nepali: "तिहार", type: "holiday" },
                { month: 6, day: 7, name: "Tihar", nepali: "तिहार", type: "holiday" },
                { month: 6, day: 10, name: "Chhath", nepali: "छठ", type: "holiday" },
                { month: 6, day: 25, name: "Falgunanda Jayanti", nepali: "फाल्गुनन्द जयन्ती", type: "holiday" },
                { month: 7, day: 17, name: "International Day of Persons with Disabilities", nepali: "अन्तर्राष्ट्रिय अपाङ्गता दिवस", type: "holiday" },
                { month: 7, day: 18, name: "Udhauli Parva, Yomari Punhi", nepali: "उधौली पर्व, योमरी पुन्ही", type: "holiday" },
                { month: 8, day: 10, name: "Christmas", nepali: "क्रिसमस", type: "holiday" },
                { month: 8, day: 15, name: "Tamu Lhosar", nepali: "तमु ल्होसार", type: "holiday" },
                { month: 8, day: 27, name: "Prithvi Jayanti", nepali: "पृथ्वी जयन्ती", type: "holiday" },
                { month: 9, day: 1, name: "Maghi Parva/Maghe Sankranti", nepali: "माघी पर्व/माघे संक्रान्ति", type: "holiday" },
                { month: 9, day: 5, name: "Sonam Lhosar", nepali: "सोनाम ल्होसार", type: "holiday" },
                { month: 9, day: 9, name: "Basanta Panchami/Saraswati Puja", nepali: "बसन्त पञ्चमी/सरस्वती पूजा", type: "holiday" },
                { month: 9, day: 16, name: "Martyrs Day", nepali: "शहीद दिवस", type: "holiday" },
                { month: 10, day: 3, name: "Maha Shivaratri", nepali: "महाशिवरात्रि", type: "holiday" },
                { month: 10, day: 6, name: "Gyalpo Lhosar", nepali: "ग्याल्पो ल्होसार", type: "holiday" },
                { month: 10, day: 7, name: "Democracy Day", nepali: "प्रजातन्त्र दिवस", type: "holiday" },
                { month: 10, day: 18, name: "Fagu Purnima", nepali: "फागु पूर्णिमा", type: "holiday" },
                { month: 10, day: 24, name: "International Women's Day", nepali: "अन्तर्राष्ट्रिय महिला दिवस", type: "holiday" },
                { month: 11, day: 1, name: "Fagu Purnima", nepali: "फागु पूर्णिमा", type: "holiday" },
                { month: 11, day: 4, name: "Ghode Jatra", nepali: "घोडेजात्रा", type: "holiday" }
            ],
            2083: [
                { month: 0, day: 1, name: "Nepali New Year", nepali: "नेपाली नयाँ वर्ष", type: "holiday" },
                { month: 5, day: 15, name: "Dashain", nepali: "दशैं", type: "holiday" },
                { month: 5, day: 29, name: "Tihar", nepali: "तिहार", type: "holiday" }
            ]
        };

        // Initialize state
        let currentYear = 2082;
        let currentMonthIndex = 0;
        let isNepali = false;
        let notes = JSON.parse(localStorage.getItem('notes')) || [];
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
        let budgets = JSON.parse(localStorage.getItem('budgets')) || {};
        let customHolidays = JSON.parse(localStorage.getItem('customHolidays')) || [];
        let shoppingList = JSON.parse(localStorage.getItem('shoppingList')) || [];
        let editingNoteIndex = null;
        let undoStack = [];

        // Language data
        const monthsNepali = ['बैशाख', 'जेठ', 'असार', 'श्रावण', 'भदौ', 'आश्विन', 'कार्तिक', 'मंसिर', 'पौष', 'माघ', 'फाल्गुन', 'चैत'];
        const daysNepali = ['आइतबार', 'सोमबार', 'मंगलबार', 'बुधबार', 'बिहीबार', 'शुक्रबार', 'शनिबार'];
        const daysEnglish = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // DOM elements
        const monthTabs = document.getElementById('monthTabs');
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonth = document.getElementById('currentMonth');
        const yearFilter = document.getElementById('yearFilter');
        const todayButton = document.getElementById('todayButton');
        const viewNotes = document.getElementById('viewNotes');
        const viewFinance = document.getElementById('viewFinance');
        const backupData = document.getElementById('backupData');
        const restoreData = document.getElementById('restoreData');
        const restoreFileInput = document.getElementById('restoreFileInput');
        const importFileInput = document.getElementById('importFileInput');
        const languageToggle = document.getElementById('languageToggle');
        const noteFormModal = new bootstrap.Modal(document.getElementById('noteFormModal'));
        const entryType = document.getElementById('entryType');
        const noteTitle = document.getElementById('noteTitle');
        const noteTime = document.getElementById('noteTime');
        const noteDescription = document.getElementById('noteDescription');
        const entryCategory = document.getElementById('entryCategory');
        const newCategory = document.getElementById('newCategory');
        const addCategory = document.getElementById('addCategory');
        const categoryManager = document.getElementById('categoryManager');
        const budgetSection = document.getElementById('budgetSection');
        const monthlyBudget = document.getElementById('monthlyBudget');
        const recurring = document.getElementById('recurring');
        const reminder = document.getElementById('reminder');
        const saveNote = document.getElementById('saveNote');
        const editEntry = document.getElementById('editEntry');
        const closeEntry = document.getElementById('closeEntry');
        const selectedDate = document.getElementById('selectedDate');
        const notesModal = new bootstrap.Modal(document.getElementById('notesModal'));
        const closeModal = document.getElementById('closeModal');
        const noteSearch = document.getElementById('noteSearch');
        const notesList = document.getElementById('notesList');
        const monthFilter = document.getElementById('monthFilter');
        const clearNotes = document.getElementById('clearNotes');
        const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
        const closeReportModal = document.getElementById('closeReportModal');
        const financeSearch = document.getElementById('financeSearch');
        const reportContent = document.getElementById('reportContent');
        const weeklyReportTab = document.getElementById('weeklyReportTab');
        const monthlyReportTab = document.getElementById('monthlyReportTab');
        const yearlyReportTab = document.getElementById('yearlyReportTab');
        const recordsReportTab = document.getElementById('recordsReportTab');
        const monthlySummary = document.getElementById('monthlySummary');
        const holidayList = document.getElementById('holidayList');
        const todayNepaliDate = document.getElementById('todayNepaliDate');
        const todayEnglishDate = document.getElementById('todayEnglishDate');
        const addNote = document.getElementById('addNote');
        const addFinance = document.getElementById('addFinance');
        const undoAction = document.getElementById('undoAction');
        const addCustomHoliday = document.getElementById('addCustomHoliday');
        const manageShoppingList = document.getElementById('manageShoppingList');
        const customHolidayModal = new bootstrap.Modal(document.getElementById('customHolidayModal'));
        const holidayDate = document.getElementById('holidayDate');
        const holidayName = document.getElementById('holidayName');
        const holidayNepaliName = document.getElementById('holidayNepaliName');
        const saveCustomHoliday = document.getElementById('saveCustomHoliday');
        const closeCustomHolidayModal = document.getElementById('closeCustomHolidayModal');
        const shoppingListModal = new bootstrap.Modal(document.getElementById('shoppingListModal'));
        const newShoppingItem = document.getElementById('newShoppingItem');
        const addShoppingItem = document.getElementById('addShoppingItem');
        const shoppingItemsList = document.getElementById('shoppingItemsList');
        const clearShoppingList = document.getElementById('clearShoppingList');
        const closeShoppingListModal = document.getElementById('closeShoppingListModal');

        // Populate month filter
        calendarData[currentYear].forEach((month, index) => {
            let option = document.createElement('option');
            option.value = index;
            option.textContent = isNepali ? monthsNepali[index] : month.name;
            monthFilter.appendChild(option);
        });

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        function getBSDateFromGregorian(date) {
            try {
                for (let year in calendarData) {
                    for (let i = 0; i < calendarData[year].length; i++) {
                        let month = calendarData[year][i];
                        let startDate = new Date(month.gregStart);
                        let endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + month.days - 1);
                        if (date >= startDate && date <= endDate) {
                            let dayDiff = Math.floor((date - startDate) / (1000 * 60 * 60 * 24)) + 1;
                            return { year: parseInt(year), month: i, day: dayDiff };
                        }
                    }
                }
                return null;
            } catch (err) {
                console.error('Error in getBSDateFromGregorian:', err);
                return null;
            }
        }

        function getGregorianDate(year, monthIndex, day) {
            try {
                let month = calendarData[year][monthIndex];
                let startDate = new Date(month.gregStart);
                startDate.setDate(startDate.getDate() + day - 1);
                return startDate;
            } catch (err) {
                console.error('Error in getGregorianDate:', err);
                return new Date();
            }
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getRecurringDates(note) {
            if (!note.recurring) return [note.date];
            let dates = [];
            let [startYear, startMonth, startDay] = note.date.split('-').map(Number);
            startMonth--;
            for (let year = startYear; year <= 2083; year++) {
                for (let month = (year === startYear ? startMonth : 0); month < 12; month++) {
                    if (calendarData[year][month].days >= startDay) {
                        dates.push(`${year}-${String(month + 1).padStart(2, '0')}-${String(startDay).padStart(2, '0')}`);
                    }
                }
            }
            return dates;
        }

        function checkReminders() {
            if (!("Notification" in window) || Notification.permission !== "granted") return;
            let today = new Date();
            let bsDate = getBSDateFromGregorian(today);
            if (!bsDate) return;
            let dateStr = `${bsDate.year}-${String(bsDate.month + 1).padStart(2, '0')}-${String(bsDate.day).padStart(2, '0')}`;
            notes.forEach(note => {
                if (note.reminder && getRecurringDates(note).includes(dateStr)) {
                    new Notification(note.title, {
                        body: note.description || (isNepali ? 'आजको लागि रिमाइन्डर' : 'Reminder for today'),
                        icon: '/path/to/icon.png'
                    });
                }
            });
            let holiday = holidays[bsDate.year]?.find(h => h.month === bsDate.month && h.day === bsDate.day);
            if (holiday) {
                new Notification(isNepali ? holiday.nepali : holiday.name, {
                    body: isNepali ? 'आजको बिदा' : 'Today\'s holiday',
                    icon: '/path/to/icon.png'
                });
            }
        }

        // Rendering functions
        function renderMonthTabs() {
            monthTabs.innerHTML = '';
            const fragment = document.createDocumentFragment();
            calendarData[currentYear].forEach((month, index) => {
                let tab = document.createElement('button');
                tab.className = `btn btn-outline-primary ${index === currentMonthIndex ? 'active' : ''}`;
                tab.setAttribute('role', 'tab');
                tab.setAttribute('aria-selected', index === currentMonthIndex);
                tab.textContent = isNepali ? monthsNepali[index] : month.name;
                if (isNepali) tab.classList.add('nepali');
                tab.addEventListener('click', () => {
                    currentMonthIndex = index;
                    monthTabs.querySelectorAll('.btn').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    renderCalendar();
                });
                fragment.appendChild(tab);
            });
            monthTabs.appendChild(fragment);
        }

        function renderCalendar() {
            let month = calendarData[currentYear]?.[currentMonthIndex];
            if (!month) {
                console.error('Invalid month data');
                currentMonth.textContent = isNepali ? 'त्रुटि: अमान्य महिना' : 'Error: Invalid Month';
                return;
            }
            currentMonth.textContent = isNepali 
                ? `${monthsNepali[currentMonthIndex]} ${currentYear} BS` 
                : `${month.name} ${currentYear} BS`;
            const fragment = document.createDocumentFragment();

            const weekdays = isNepali ? daysNepali : daysEnglish;
            weekdays.forEach(day => {
                let dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day bg-primary text-white text-center py-2';
                dayHeader.textContent = day;
                fragment.appendChild(dayHeader);
            });

            let startDate = new Date(month.gregStart);
            let firstDay = startDate.getDay();
            let today = new Date();
            let todayBS = getBSDateFromGregorian(today);

            for (let i = 0; i < firstDay; i++) {
                let emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day bg-light';
                fragment.appendChild(emptyDay);
            }

            for (let day = 1; day <= month.days; day++) {
                let gregDate = getGregorianDate(currentYear, currentMonthIndex, day);
                let dayDiv = document.createElement('div');
                dayDiv.className = `calendar-day bg-white border p-2 ${todayBS && todayBS.year === currentYear && todayBS.month === currentMonthIndex && todayBS.day === day ? 'today' : ''}`;
                dayDiv.setAttribute('role', 'gridcell');
                dayDiv.setAttribute('tabindex', '0');
                if (gregDate.getDay() === 6) dayDiv.classList.add('saturday');

                let dateStr = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let holiday = holidays[currentYear]?.find(h => h.month === currentMonthIndex && h.day === day);
                let customHoliday = customHolidays.find(ch => ch.date === dateStr);

                if (holiday) {
                    dayDiv.classList.add('holiday');
                    let festivalDiv = document.createElement('div');
                    festivalDiv.className = 'festival';
                    festivalDiv.textContent = isNepali ? holiday.nepali : holiday.name;
                    dayDiv.appendChild(festivalDiv);

                    let tooltip = document.createElement('div');
                    tooltip.className = 'festival-tooltip';
                    tooltip.textContent = isNepali ? holiday.nepali : holiday.name;
                    dayDiv.appendChild(tooltip);
                } else if (customHoliday) {
                    dayDiv.classList.add('custom-holiday');
                    let festivalDiv = document.createElement('div');
                    festivalDiv.className = 'festival';
                    festivalDiv.textContent = isNepali ? customHoliday.nepali : customHoliday.name;
                    dayDiv.appendChild(festivalDiv);

                    let tooltip = document.createElement('div');
                    tooltip.className = 'festival-tooltip';
                    tooltip.textContent = isNepali ? customHoliday.nepali : customHoliday.name;
                    dayDiv.appendChild(tooltip);
                }

                let bsDate = document.createElement('div');
                bsDate.className = 'bs-date';
                bsDate.textContent = isNepali ? (day).toString() : day;
                dayDiv.appendChild(bsDate);

                let gregDateDiv = document.createElement('div');
                gregDateDiv.className = 'greg-date';
                gregDateDiv.textContent = gregDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                dayDiv.appendChild(gregDateDiv);

                let dayNotes = notes.filter(note => getRecurringDates(note).includes(dateStr));
                dayNotes.forEach(note => {
                    let indicator = document.createElement('div');
                    let tooltip = document.createElement('div');
                    let preview = document.createElement('div');
                    preview.className = 'event-preview';
                    if (note.type === 'note') {
                        indicator.className = 'note-indicator';
                        tooltip.className = 'note-tooltip';
                        tooltip.textContent = note.title;
                        preview.textContent = note.title.substring(0, 15) + (note.title.length > 15 ? '...' : '');
                    } else if (note.type === 'income') {
                        indicator.className = 'income-indicator';
                        tooltip.className = 'finance-tooltip';
                        tooltip.textContent = `Income: ${note.title} NPR`;
                        preview.textContent = `+${note.title} NPR`;
                    } else if (note.type === 'expense') {
                        indicator.className = 'expense-indicator';
                        tooltip.className = 'finance-tooltip';
                        tooltip.textContent = `Expense: ${note.title} NPR`;
                        preview.textContent = `-${note.title} NPR`;
                    }
                    dayDiv.appendChild(indicator);
                    dayDiv.appendChild(tooltip);
                    dayDiv.appendChild(preview);
                });

                dayDiv.addEventListener('click', () => {
                    let gregDate = getGregorianDate(currentYear, currentMonthIndex, day);
                    selectedDate.value = formatDate(gregDate);
                    entryType.value = 'note';
                    noteTitle.value = '';
                    noteTime.value = '';
                    noteDescription.value = '';
                    recurring.checked = false;
                    reminder.checked = false;
                    entryCategory.style.display = 'none';
                    categoryManager.style.display = 'none';
                    budgetSection.style.display = 'none';
                    saveNote.style.display = 'block';
                    editEntry.style.display = 'none';
                    noteFormModal.show();
                    noteTitle.focus();
                });

                dayDiv.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        dayDiv.click();
                    }
                });

                fragment.appendChild(dayDiv);
            }

            calendarGrid.innerHTML = '';
            calendarGrid.appendChild(fragment);
            renderMonthlySummary();
            renderHolidays();
        }

        function renderMonthlySummary() {
            let income = 0, expense = 0;
            let dateStr = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}`;
            let monthNotes = notes.filter(note => getRecurringDates(note).some(d => d.startsWith(dateStr)) && (note.type === 'income' || note.type === 'expense'));
            monthNotes.forEach(note => {
                if (note.type === 'income') income += parseFloat(note.title || 0);
                else if (note.type === 'expense') expense += parseFloat(note.title || 0);
            });
            let budget = budgets[dateStr] || 0;
            let variance = budget ? budget - expense : 0;
            monthlySummary.innerHTML = isNepali
                ? `कुल आय: ${income} NPR<br>कुल खर्च: ${expense} NPR<br>ब्यालेन्स: ${income - expense} NPR<br>बजेट: ${budget} NPR<br>भिन्नता: ${variance} NPR`
                : `Total Income: ${income} NPR<br>Total Expense: ${expense} NPR<br>Balance: ${income - expense} NPR<br>Budget: ${budget} NPR<br>Variance: ${variance} NPR`;
        }

        function renderHolidays() {
            const fragment = document.createDocumentFragment();
            let monthHolidays = (holidays[currentYear] || []).filter(h => h.month === currentMonthIndex);
            let monthCustomHolidays = customHolidays.filter(ch => {
                let [year, month] = ch.date.split('-').map(Number);
                return year === currentYear && (month - 1) === currentMonthIndex;
            });
            let allHolidays = [...monthHolidays, ...monthCustomHolidays.map(ch => ({
                day: parseInt(ch.date.split('-')[2]),
                name: ch.name,
                nepali: ch.nepali,
                type: 'custom-holiday'
            }))];

            if (allHolidays.length === 0) {
                let li = document.createElement('li');
                li.textContent = isNepali ? 'यस महिनामा कुनै बिदा छैन' : 'No holidays this month';
                fragment.appendChild(li);
            } else {
                allHolidays.forEach(holiday => {
                    let li = document.createElement('li');
                    li.textContent = `${isNepali ? holiday.nepali : holiday.name} - ${holiday.day} ${isNepali ? monthsNepali[currentMonthIndex] : calendarData[currentYear][currentMonthIndex].name}`;
                    if (isNepali) li.classList.add('nepali');
                    fragment.appendChild(li);
                });
            }
            holidayList.innerHTML = '';
            holidayList.appendChild(fragment);
        }

        function renderNotesList() {
            notesList.innerHTML = '';
            let filteredNotes = notes.filter(note => getRecurringDates(note).includes(formatBSDate(getBSDateFromGregorian(new Date(selectedDate.value)))));
            filteredNotes.forEach((note, index) => {
                let li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                let noteText = note.type === 'note' 
                    ? `${note.title}${note.time ? ` (${note.time})` : ''}${note.recurring ? (isNepali ? ' (मासिक)' : ' (Recurring)') : ''}${note.reminder ? (isNepali ? ' (रिमाइन्डर)' : ' (Reminder)') : ''}`
                    : `${note.type === 'income' ? (isNepali ? 'आय' : 'Income') : (isNepali ? 'खर्च' : 'Expense')}: ${note.title} NPR${note.category ? ` (${note.category})` : ''}${note.recurring ? (isNepali ? ' (मासिक)' : ' (Recurring)') : ''}`;
                li.textContent = noteText;

                let btnGroup = document.createElement('div');
                let editBtn = document.createElement('button');
                editBtn.className = 'btn btn-sm btn-outline-primary me-2';
                editBtn.textContent = isNepali ? 'सम्पादन' : 'Edit';
                editBtn.addEventListener('click', () => {
                    editingNoteIndex = index;
                    let gregDate = getGregorianDate(parseInt(note.date.split('-')[0]), parseInt(note.date.split('-')[1]) - 1, parseInt(note.date.split('-')[2]));
                    selectedDate.value = formatDate(gregDate);
                    entryType.value = note.type;
                    noteTitle.value = note.title;
                    noteTime.value = note.time || '';
                    noteDescription.value = note.description || '';
                    recurring.checked = note.recurring || false;
                    reminder.checked = note.reminder || false;
                    entryCategory.style.display = note.type === 'note' ? 'none' : 'block';
                    categoryManager.style.display = note.type === 'note' ? 'none' : 'block';
                    budgetSection.style.display = 'none';
                    saveNote.style.display = 'none';
                    editEntry.style.display = 'block';
                    noteFormModal.show();
                    noteTitle.focus();
                });

                let deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-sm btn-outline-danger';
                deleteBtn.textContent = isNepali ? 'हटाउनुहोस्' : 'Delete';
                deleteBtn.addEventListener('click', () => {
                    undoStack.push({ action: 'delete', note: notes[index], index });
                    notes.splice(index, 1);
                    localStorage.setItem('notes', JSON.stringify(notes));
                    renderNotesList();
                    renderCalendar();
                });

                btnGroup.appendChild(editBtn);
                btnGroup.appendChild(deleteBtn);
                li.appendChild(btnGroup);
                notesList.appendChild(li);
            });

            if (filteredNotes.length === 0) {
                let li = document.createElement('li');
                li.className = 'list-group-item';
                li.textContent = isNepali ? 'कुनै नोटहरू छैनन्' : 'No notes available';
                notesList.appendChild(li);
            }
        }

        function renderReport(type) {
            reportContent.innerHTML = '';
            let reportData = [];
            if (type === 'weekly') {
                let weeks = {};
                notes.forEach(note => {
                    let [year, month, day] = note.date.split('-').map(Number);
                    if (year === currentYear && month - 1 === currentMonthIndex) {
                        let gregDate = getGregorianDate(year, month - 1, day);
                        let weekNumber = Math.ceil((gregDate.getDate() + (new Date(gregDate.getFullYear(), gregDate.getMonth(), 1).getDay())) / 7);
                        if (!weeks[weekNumber]) weeks[weekNumber] = { income: 0, expense: 0 };
                        if (note.type === 'income') weeks[weekNumber].income += parseFloat(note.title);
                        else if (note.type === 'expense') weeks[weekNumber].expense += parseFloat(note.title);
                    }
                });
                for (let week in weeks) {
                    reportData.push(`${isNepali ? `हप्ता ${week}` : `Week ${week}`}: ${isNepali ? 'आय' : 'Income'}: ${weeks[week].income} NPR, ${isNepali ? 'खर्च' : 'Expense'}: ${weeks[week].expense} NPR`);
                }
            } else if (type === 'monthly') {
                let months = {};
                notes.forEach(note => {
                    let [year, month] = note.date.split('-').map(Number);
                    if (year === currentYear) {
                        if (!months[month]) months[month] = { income: 0, expense: 0 };
                        if (note.type === 'income') months[month].income += parseFloat(note.title);
                        else if (note.type === 'expense') months[month].expense += parseFloat(note.title);
                    }
                });
                for (let month in months) {
                    reportData.push(`${isNepali ? monthsNepali[month - 1] : calendarData[currentYear][month - 1].name}: ${isNepali ? 'आय' : 'Income'}: ${months[month].income} NPR, ${isNepali ? 'खर्च' : 'Expense'}: ${months[month].expense} NPR`);
                }
            } else if (type === 'yearly') {
                let years = {};
                notes.forEach(note => {
                    let [year] = note.date.split('-').map(Number);
                    if (!years[year]) years[year] = { income: 0, expense: 0 };
                    if (note.type === 'income') years[year].income += parseFloat(note.title);
                    else if (note.type === 'expense') years[year].expense += parseFloat(note.title);
                });
                for (let year in years) {
                    reportData.push(`${year} BS: ${isNepali ? 'आय' : 'Income'}: ${years[year].income} NPR, ${isNepali ? 'खर्च' : 'Expense'}: ${years[year].expense} NPR`);
                }
            }

            if (reportData.length === 0) {
                reportContent.textContent = isNepali ? 'कुनै डाटा छैन' : 'No data available';
            } else {
                reportData.forEach(line => {
                    let p = document.createElement('p');
                    p.textContent = line;
                    reportContent.appendChild(p);
                });
            }
        }

        function renderFinancialRecords() {
            reportContent.innerHTML = '';
            let finances = notes.filter(note => note.type === 'income' || note.type === 'expense');
            if (finances.length === 0) {
                reportContent.textContent = isNepali ? 'कुनै वित्तीय रेकर्ड छैन' : 'No financial records available';
            } else {
                finances.forEach(note => {
                    let p = document.createElement('p');
                    p.textContent = `${note.date}: ${note.type === 'income' ? (isNepali ? 'आय' : 'Income') : (isNepali ? 'खर्च' : 'Expense')}: ${note.title} NPR${note.category ? ` (${note.category})` : ''}${note.recurring ? (isNepali ? ' (मासिक)' : ' (Recurring)') : ''}`;
                    reportContent.appendChild(p);
                });
            }
        }

        function renderShoppingList() {
            shoppingItemsList.innerHTML = '';
            shoppingList.forEach((item, index) => {
                let li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                let textSpan = document.createElement('span');
                textSpan.textContent = item.text || item;
                textSpan.style.textDecoration = item.completed ? 'line-through' : 'none';

                let btnGroup = document.createElement('div');
                let toggleBtn = document.createElement('button');
                toggleBtn.className = 'btn btn-sm btn-outline-success me-2';
                toggleBtn.textContent = item.completed ? (isNepali ? 'अनडु' : 'Undo') : (isNepali ? 'पूरा' : 'Done');
                toggleBtn.addEventListener('click', () => {
                    shoppingList[index].completed = !shoppingList[index].completed;
                    localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
                    renderShoppingList();
                });

                let deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-sm btn-outline-danger';
                deleteBtn.textContent = isNepali ? 'हटाउनुहोस्' : 'Delete';
deleteBtn.addEventListener('click', () => {
    shoppingList.splice(index, 1);
    localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
    renderShoppingList();
});

btnGroup.appendChild(toggleBtn);
btnGroup.appendChild(deleteBtn);
li.appendChild(textSpan);
li.appendChild(btnGroup);
shoppingItemsList.appendChild(li);
});

if (shoppingList.length === 0) {
    let li = document.createElement('li');
    li.className = 'list-group-item';
    li.textContent = isNepali ? 'कुनै सामानहरू छैनन्' : 'No items in the list';
    shoppingItemsList.appendChild(li);
}
}
function getCurrentDateString() {
    let today = new Date();
    let bsDate = getBSDateFromGregorian(today);
    if (!bsDate) return '';
    return `${bsDate.year}-${String(bsDate.month + 1).padStart(2, '0')}-${String(bsDate.day).padStart(2, '0')}`;
}

function formatBSDate(bsDate) {
    if (!bsDate) return '';
    return `${bsDate.year}-${String(bsDate.month + 1).padStart(2, '0')}-${String(bsDate.day).padStart(2, '0')}`;
}

function exportToExcel(type) {
    let data = [];
    if (type === 'note') {
        data = notes.filter(n => n.type === 'note').map(note => ({
            Date: note.date,
            Title: note.title,
            Description: note.description || '',
            Time: note.time || '',
            Recurring: note.recurring ? 'Yes' : 'No',
            Reminder: note.reminder ? 'Yes' : 'No'
        }));
    } else if (type === 'finance') {
        data = notes.filter(n => n.type === 'income' || n.type === 'expense').map(note => ({
            Date: note.date,
            Type: note.type,
            Amount: note.title,
            Category: note.category || '',
            Description: note.description || '',
            Recurring: note.recurring ? 'Yes' : 'No'
        }));
    } else if (type === 'calendar') {
        let days = [];
        for (let monthIndex = 0; monthIndex < calendarData[currentYear].length; monthIndex++) {
            let month = calendarData[currentYear][monthIndex];
            for (let day = 1; day <= month.days; day++) {
                let dateStr = `${currentYear}-${String(monthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let gregDate = getGregorianDate(currentYear, monthIndex, day);
                let holiday = holidays[currentYear]?.find(h => h.month === monthIndex && h.day === day);
                let customHoliday = customHolidays.find(ch => ch.date === dateStr);
                let dayNotes = notes.filter(n => getRecurringDates(n).includes(dateStr));
                days.push({
                    Date: dateStr,
                    Gregorian: gregDate.toISOString().split('T')[0],
                    Notes: dayNotes.filter(n => n.type === 'note').map(n => n.title).join('; ') || '',
                    Income: dayNotes.filter(n => n.type === 'income').map(n => n.title).join('; ') || '',
                    Expense: dayNotes.filter(n => n.type === 'expense').map(n => n.title).join('; ') || '',
                    Holiday: holiday ? (isNepali ? holiday.nepali : holiday.name) : (customHoliday ? (isNepali ? customHoliday.nepali : customHoliday.name) : '')
                });
            }
        }
        data = days;
    } else if (type === 'holiday') {
        let allHolidays = [];
        for (let monthIndex = 0; monthIndex < calendarData[currentYear].length; monthIndex++) {
            let monthHolidays = holidays[currentYear]?.filter(h => h.month === monthIndex) || [];
            let monthCustomHolidays = customHolidays.filter(ch => {
                let [year, month] = ch.date.split('-').map(Number);
                return year === currentYear && (month - 1) === monthIndex;
            });
            monthHolidays.forEach(h => {
                allHolidays.push({
                    Date: `${currentYear}-${String(monthIndex + 1).padStart(2, '0')}-${String(h.day).padStart(2, '0')}`,
                    Name: isNepali ? h.nepali : h.name,
                    Type: h.type
                });
            });
            monthCustomHolidays.forEach(ch => {
                allHolidays.push({
                    Date: ch.date,
                    Name: isNepali ? ch.nepali : ch.name,
                    Type: 'custom-holiday'
                });
            });
        }
        data = allHolidays;
    }

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, type.charAt(0).toUpperCase() + type.slice(1));
    XLSX.writeFile(wb, `${type}_export_${currentYear}.xlsx`);
}

function exportToPDF(type) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let yOffset = 10;

    doc.setFontSize(16);
    doc.text(type.charAt(0).toUpperCase() + type.slice(1) + ` Data ${currentYear}`, 10, yOffset);
    yOffset += 10;

    if (type === 'note') {
        notes.filter(n => n.type === 'note').forEach((note, index) => {
            doc.setFontSize(12);
            doc.text(`Note ${index + 1}: ${note.title}`, 10, yOffset);
            yOffset += 5;
            doc.setFontSize(10);
            doc.text(`Date: ${note.date}`, 10, yOffset);
            yOffset += 5;
            doc.text(`Description: ${note.description || 'N/A'}`, 10, yOffset);
            yOffset += 5;
            doc.text(`Time: ${note.time || 'N/A'}`, 10, yOffset);
            yOffset += 5;
            doc.text(`Recurring: ${note.recurring ? 'Yes' : 'No'}`, 10, yOffset);
            yOffset += 5;
            doc.text(`Reminder: ${note.reminder ? 'Yes' : 'No'}`, 10, yOffset);
            yOffset += 10;
            if (yOffset > 270) {
                doc.addPage();
                yOffset = 10;
            }
        });
    } else if (type === 'finance') {
        notes.filter(n => n.type === 'income' || n.type === 'expense').forEach((note, index) => {
            doc.setFontSize(12);
            doc.text(`${note.type.charAt(0).toUpperCase() + note.type.slice(1)} ${index + 1}: ${note.title} NPR`, 10, yOffset);
            yOffset += 5;
            doc.setFontSize(10);
            doc.text(`Date: ${note.date}`, 10, yOffset);
            yOffset += 5;
            doc.text(`Category: ${note.category || 'N/A'}`, 10, yOffset);
            yOffset += 5;
            doc.text(`Description: ${note.description || 'N/A'}`, 10, yOffset);
            yOffset += 5;
            doc.text(`Recurring: ${note.recurring ? 'Yes' : 'No'}`, 10, yOffset);
            yOffset += 10;
            if (yOffset > 270) {
                doc.addPage();
                yOffset = 10;
            }
        });
    } else if (type === 'calendar') {
        for (let monthIndex = 0; monthIndex < calendarData[currentYear].length; monthIndex++) {
            let month = calendarData[currentYear][monthIndex];
            doc.setFontSize(14);
            doc.text(isNepali ? monthsNepali[monthIndex] : month.name, 10, yOffset);
            yOffset += 10;
            for (let day = 1; day <= month.days; day++) {
                let dateStr = `${currentYear}-${String(monthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let gregDate = getGregorianDate(currentYear, monthIndex, day);
                let holiday = holidays[currentYear]?.find(h => h.month === monthIndex && h.day === day);
                let customHoliday = customHolidays.find(ch => ch.date === dateStr);
                let dayNotes = notes.filter(n => getRecurringDates(n).includes(dateStr));
                doc.setFontSize(10);
                doc.text(`Day ${day} (${gregDate.toISOString().split('T')[0]}):`, 10, yOffset);
                yOffset += 5;
                if (holiday) {
                    doc.text(`Holiday: ${isNepali ? holiday.nepali : holiday.name}`, 15, yOffset);
                    yOffset += 5;
                } else if (customHoliday) {
                    doc.text(`Custom Holiday: ${isNepali ? customHoliday.nepali : customHoliday.name}`, 15, yOffset);
                    yOffset += 5;
                }
                if (dayNotes.length > 0) {
                    dayNotes.forEach(note => {
                        if (note.type === 'note') {
                            doc.text(`Note: ${note.title}`, 15, yOffset);
                            yOffset += 5;
                        } else if (note.type === 'income') {
                            doc.text(`Income: ${note.title} NPR`, 15, yOffset);
                            yOffset += 5;
                        } else if (note.type === 'expense') {
                            doc.text(`Expense: ${note.title} NPR`, 15, yOffset);
                            yOffset += 5;
                        }
                    });
                }
                yOffset += 5;
                if (yOffset > 270) {
                    doc.addPage();
                    yOffset = 10;
                }
            }
        }
    }

    doc.save(`${type}_export_${currentYear}.pdf`);
}

function importData(type, file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            if (file.name.endsWith('.json')) {
                const importedData = JSON.parse(content);
                if (type === 'note') {
                    notes = notes.filter(n => n.type !== 'note');
                    notes.push(...importedData.filter(d => d.type === 'note'));
                } else if (type === 'finance') {
                    notes = notes.filter(n => n.type !== 'income' && n.type !== 'expense');
                    notes.push(...importedData.filter(d => d.type === 'income' || d.type === 'expense'));
                } else if (type === 'calendar') {
                    notes = importedData;
                } else if (type === 'holiday') {
                    customHolidays = importedData;
                    localStorage.setItem('customHolidays', JSON.stringify(customHolidays));
                }
            } else if (file.name.endsWith('.xlsx')) {
                const workbook = XLSX.read(content, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const importedData = XLSX.utils.sheet_to_json(sheet);
                if (type === 'note') {
                    notes = notes.filter(n => n.type !== 'note');
                    importedData.forEach(d => {
                        notes.push({
                            date: d.Date,
                            type: 'note',
                            title: d.Title,
                            description: d.Description || '',
                            time: d.Time || '',
                            recurring: d.Recurring === 'Yes',
                            reminder: d.Reminder === 'Yes'
                        });
                    });
                } else if (type === 'finance') {
                    notes = notes.filter(n => n.type !== 'income' && n.type !== 'expense');
                    importedData.forEach(d => {
                        notes.push({
                            date: d.Date,
                            type: d.Type,
                            title: d.Amount,
                            category: d.Category || '',
                            description: d.Description || '',
                            recurring: d.Recurring === 'Yes'
                        });
                    });
                } else if (type === 'holiday') {
                    customHolidays = importedData.map(d => ({
                        date: d.Date,
                        name: d.Name,
                        nepali: d.Name,
                        type: d.Type || 'custom-holiday'
                    }));
                    localStorage.setItem('customHolidays', JSON.stringify(customHolidays));
                }
            }
            localStorage.setItem('notes', JSON.stringify(notes));
            renderCalendar();
            renderNotesList();
            renderFinancialRecords();
            alert(isNepali ? 'डाटा सफलतापूर्वक आयात गरियो' : 'Data imported successfully');
        } catch (err) {
            console.error('Import error:', err);
            alert(isNepali ? 'डाटा आयात गर्दा त्रुटि' : 'Error importing data');
        }
    };
    if (file.name.endsWith('.xlsx')) {
        reader.readAsBinaryString(file);
    } else {
        reader.readAsText(file);
    }
}

function backupDataFunc() {
    const backupData = {
        notes,
        customHolidays,
        shoppingList,
        budgets,
        customCategories
    };
    const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `calendar_backup_${currentYear}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function restoreDataFunc(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            notes = data.notes || [];
            customHolidays = data.customHolidays || [];
            shoppingList = data.shoppingList || [];
            budgets = data.budgets || {};
            customCategories = data.customCategories || [];
            localStorage.setItem('notes', JSON.stringify(notes));
            localStorage.setItem('customHolidays', JSON.stringify(customHolidays));
            localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
            localStorage.setItem('budgets', JSON.stringify(budgets));
            localStorage.setItem('customCategories', JSON.stringify(customCategories));
            renderCalendar();
            renderNotesList();
            renderFinancialRecords();
            renderShoppingList();
            alert(isNepali ? 'डाटा सफलतापूर्वक पुनर्स्थापना गरियो' : 'Data restored successfully');
        } catch (err) {
            console.error('Restore error:', err);
            alert(isNepali ? 'डाटा पुनर्स्थापना गर्दा त्रुटि' : 'Error restoring data');
        }
    };
    reader.readAsText(file);
}

function updateLanguage() {
    document.querySelectorAll('[data-en][data-ne]').forEach(elem => {
        elem.textContent = isNepali ? elem.dataset.ne : elem.dataset.en;
        if (isNepali) elem.classList.add('nepali');
        else elem.classList.remove('nepali');
    });

    const options = document.querySelectorAll('option[data-en][data-ne]');
    options.forEach(option => {
        option.textContent = isNepali ? option.dataset.ne : option.dataset.en;
    });

    languageToggle.textContent = isNepali ? 'Switch to English' : 'Switch to Nepali';
    renderMonthTabs();
    renderCalendar();
    renderNotesList();
    renderFinancialRecords();
    renderShoppingList();

    let today = new Date();
    let bsDate = getBSDateFromGregorian(today);
    if (bsDate) {
        todayNepaliDate.textContent = `${bsDate.day} ${monthsNepali[bsDate.month]} ${bsDate.year} BS`;
        todayEnglishDate.textContent = today.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }
}

function requestNotificationPermission() {
    if (!("Notification" in window)) {
        alert(isNepali ? 'यो ब्राउजरले नोटिफिकेसन समर्थन गर्दैन' : 'This browser does not support notifications');
        return;
    }
    Notification.requestPermission().then(permission => {
        if (permission === "granted") {
            checkReminders();
        }
    });
}

// Event Listeners
yearFilter.addEventListener('change', () => {
    currentYear = parseInt(yearFilter.value);
    currentMonthIndex = 0;
    renderMonthTabs();
    renderCalendar();
});

todayButton.addEventListener('click', () => {
    let today = new Date();
    let bsDate = getBSDateFromGregorian(today);
    if (bsDate) {
        currentYear = bsDate.year;
        currentMonthIndex = bsDate.month;
        yearFilter.value = currentYear;
        renderMonthTabs();
        renderCalendar();
    }
});

addNote.addEventListener('click', () => {
    let today = new Date();
    selectedDate.value = formatDate(today);
    entryType.value = 'note';
    noteTitle.value = '';
    noteTime.value = '';
    noteDescription.value = '';
    recurring.checked = false;
    reminder.checked = false;
    entryCategory.style.display = 'none';
    categoryManager.style.display = 'none';
    budgetSection.style.display = 'none';
    saveNote.style.display = 'block';
    editEntry.style.display = 'none';
    noteFormModal.show();
    noteTitle.focus();
});

addFinance.addEventListener('click', () => {
    let today = new Date();
    selectedDate.value = formatDate(today);
    entryType.value = 'income';
    noteTitle.value = '';
    noteTime.value = '';
    noteDescription.value = '';
    recurring.checked = false;
    reminder.checked = false;
    entryCategory.style.display = 'block';
    categoryManager.style.display = 'block';
    budgetSection.style.display = 'none';
    saveNote.style.display = 'block';
    editEntry.style.display = 'none';
    noteFormModal.show();
    noteTitle.focus();
});

entryType.addEventListener('change', () => {
    entryCategory.style.display = entryType.value === 'note' ? 'none' : 'block';
    categoryManager.style.display = entryType.value === 'note' ? 'none' : 'block';
    budgetSection.style.display = entryType.value === 'budget' ? 'block' : 'none';
});

addCategory.addEventListener('click', () => {
    let category = newCategory.value.trim();
    if (category && !customCategories.includes(category)) {
        customCategories.push(category);
        localStorage.setItem('customCategories', JSON.stringify(customCategories));
        let option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        document.getElementById('category').appendChild(option);
        newCategory.value = '';
    }
});

saveNote.addEventListener('click', () => {
    let date = selectedDate.value;
    let bsDate = getBSDateFromGregorian(new Date(date));
    if (!bsDate) {
        alert(isNepali ? 'अमान्य मिति' : 'Invalid date');
        return;
    }
    let dateStr = formatBSDate(bsDate);
    let title = noteTitle.value.trim();
    if (!title) {
        alert(isNepali ? 'शीर्षक खाली हुन सक्दैन' : 'Title cannot be empty');
        return;
    }
    let note = {
        date: dateStr,
        type: entryType.value,
        title,
        time: noteTime.value,
        description: noteDescription.value,
        recurring: recurring.checked,
        reminder: reminder.checked
    };
    if (entryType.value === 'income' || entryType.value === 'expense') {
        note.category = document.getElementById('category').value;
    }
    if (entryType.value === 'budget') {
        budgets[dateStr.substring(0, 7)] = parseFloat(title);
        localStorage.setItem('budgets', JSON.stringify(budgets));
    } else {
        notes.push(note);
        localStorage.setItem('notes', JSON.stringify(notes));
        undoStack.push({ action: 'add', note });
    }
    noteFormModal.hide();
    renderCalendar();
    renderNotesList();
    renderFinancialRecords();
    checkReminders();
});

editEntry.addEventListener('click', () => {
    let date = selectedDate.value;
    let bsDate = getBSDateFromGregorian(new Date(date));
    if (!bsDate) {
        alert(isNepali ? 'अमान्य मिति' : 'Invalid date');
        return;
    }
    let dateStr = formatBSDate(bsDate);
    let title = noteTitle.value.trim();
    if (!title) {
        alert(isNepali ? 'शीर्षक खाली हुन सक्दैन' : 'Title cannot be empty');
        return;
    }
    let oldNote = notes[editingNoteIndex];
    let updatedNote = {
        date: dateStr,
        type: entryType.value,
        title,
        time: noteTime.value,
        description: noteDescription.value,
        recurring: recurring.checked,
        reminder: reminder.checked
    };
    if (entryType.value === 'income' || entryType.value === 'expense') {
        updatedNote.category = document.getElementById('category').value;
    }
    notes[editingNoteIndex] = updatedNote;
    localStorage.setItem('notes', JSON.stringify(notes));
    undoStack.push({ action: 'edit', oldNote, newNote: updatedNote, index: editingNoteIndex });
    noteFormModal.hide();
    editingNoteIndex = null;
    renderCalendar();
    renderNotesList();
    renderFinancialRecords();
});

closeEntry.addEventListener('click', () => {
    editingNoteIndex = null;
});

viewNotes.addEventListener('click', () => {
    renderNotesList();
    notesModal.show();
});

noteSearch.addEventListener('input', debounce(() => {
    renderNotesList();
}, 300));

monthFilter.addEventListener('change', () => {
    renderNotesList();
});

clearNotes.addEventListener('click', () => {
    undoStack.push({ action: 'clear', notes: [...notes] });
    notes = [];
    localStorage.setItem('notes', JSON.stringify(notes));
    renderNotesList();
    renderCalendar();
});

viewFinance.addEventListener('click', () => {
    renderReport('weekly');
    reportModal.show();
});

financeSearch.addEventListener('input', debounce(() => {
    renderFinancialRecords();
}, 300));

weeklyReportTab.addEventListener('click', e => {
    e.preventDefault();
    reportModal._element.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
    weeklyReportTab.classList.add('active');
    renderReport('weekly');
});

monthlyReportTab.addEventListener('click', e => {
    e.preventDefault();
    reportModal._element.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
    monthlyReportTab.classList.add('active');
    renderReport('monthly');
});

yearlyReportTab.addEventListener('click', e => {
    e.preventDefault();
    reportModal._element.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
    yearlyReportTab.classList.add('active');
    renderReport('yearly');
});

recordsReportTab.addEventListener('click', e => {
    e.preventDefault();
    reportModal._element.querySelectorAll('.nav-link').forEach(tab => tab.classList.remove('active'));
    recordsReportTab.classList.add('active');
    renderFinancialRecords();
});

document.querySelectorAll('.excel-option').forEach(option => {
    option.addEventListener('click', e => {
        e.preventDefault();
        exportToExcel(option.dataset.type);
    });
});

document.querySelectorAll('.pdf-option').forEach(option => {
    option.addEventListener('click', e => {
        e.preventDefault();
        exportToPDF(option.dataset.type);
    });
});

document.querySelectorAll('.import-option').forEach(option => {
    option.addEventListener('click', e => {
        e.preventDefault();
        importFileInput.dataset.type = option.dataset.type;
        importFileInput.click();
    });
});

importFileInput.addEventListener('change', e => {
    if (e.target.files.length > 0) {
        importData(importFileInput.dataset.type, e.target.files[0]);
    }
});

backupData.addEventListener('click', e => {
    e.preventDefault();
    backupDataFunc();
});

restoreData.addEventListener('click', e => {
    e.preventDefault();
    restoreFileInput.click();
});

restoreFileInput.addEventListener('change', e => {
    if (e.target.files.length > 0) {
        restoreDataFunc(e.target.files[0]);
    }
});

languageToggle.addEventListener('click', () => {
    isNepali = !isNepali;
    localStorage.setItem('isNepali', JSON.stringify(isNepali));
    updateLanguage();
});

undoAction.addEventListener('click', () => {
    if (undoStack.length === 0) return;
    let lastAction = undoStack.pop();
    if (lastAction.action === 'add') {
        notes = notes.filter(n => n !== lastAction.note);
    } else if (lastAction.action === 'delete') {
        notes.splice(lastAction.index, 0, lastAction.note);
    } else if (lastAction.action === 'edit') {
        notes[lastAction.index] = lastAction.oldNote;
    } else if (lastAction.action === 'clear') {
        notes = lastAction.notes;
    }
    localStorage.setItem('notes', JSON.stringify(notes));
    renderCalendar();
    renderNotesList();
    renderFinancialRecords();
});

addCustomHoliday.addEventListener('click', () => {
    holidayDate.value = '';
    holidayName.value = '';
    holidayNepaliName.value = '';
    customHolidayModal.show();
});

saveCustomHoliday.addEventListener('click', () => {
    let date = holidayDate.value;
    let bsDate = getBSDateFromGregorian(new Date(date));
    if (!bsDate) {
        alert(isNepali ? 'अमान्य मिति' : 'Invalid date');
        return;
    }
    let dateStr = formatBSDate(bsDate);
    let name = holidayName.value.trim();
    let nepaliName = holidayNepaliName.value.trim();
    if (!name || !nepaliName) {
        alert(isNepali ? 'नाम र नेपाली नाम खाली हुन सक्दैन' : 'Name and Nepali name cannot be empty');
        return;
    }
    customHolidays.push({ date: dateStr, name, nepali: nepaliName });
    localStorage.setItem('customHolidays', JSON.stringify(customHolidays));
    customHolidayModal.hide();
    renderCalendar();
});

manageShoppingList.addEventListener('click', () => {
    renderShoppingList();
    shoppingListModal.show();
});

addShoppingItem.addEventListener('click', () => {
    let itemText = newShoppingItem.value.trim();
    if (itemText) {
        shoppingList.push({ text: itemText, completed: false });
        localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
        newShoppingItem.value = '';
        renderShoppingList();
    }
});

clearShoppingList.addEventListener('click', () => {
    shoppingList = [];
    localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
    renderShoppingList();
});

// Initialize
function init() {
    let today = new Date();
    let bsDate = getBSDateFromGregorian(today);
    if (bsDate) {
        currentYear = bsDate.year;
        currentMonthIndex = bsDate.month;
        yearFilter.value = currentYear;
        todayNepaliDate.textContent = `${bsDate.day} ${monthsNepali[bsDate.month]} ${bsDate.year} BS`;
        todayEnglishDate.textContent = today.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    }

    isNepali = JSON.parse(localStorage.getItem('isNepali')) || false;
    updateLanguage();
    renderMonthTabs();
    renderCalendar();
    requestNotificationPermission();
}

init();
</script>
</body>
</html>
