<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'nonce-OGY1ZmVhYWEtOGRlNy00YjRhLTk4NzEtNjY2OWU2MGNiN2Y2' 'strict-dynamic' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net;
        img-src 'self' blob: data: https://assets.grok.com https://imgs.search.brave.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com;
        connect-src 'self' https://api.grok.com;
    ">
    <title>Nepali Calendar 2082</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Noto+Sans+Devanagari:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{--primary:#d32f2f;--secondary:#0288d1;--accent:#fbc02d;--bg:#f5f5f5;--card-bg:#fff;--text:#212121;--text-light:#757575;--income:#4caf50;--expense:#d32f2f}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Poppins',sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
        .header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;text-align:center;padding:1.5rem;font-size:1.5rem;box-shadow:0 4px 12px rgba(0,0,0,0.2);position:relative}
        .month-tabs{display:flex;overflow-x:auto;background:var(--card-bg);padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,0.1);margin:1rem 0;visibility:visible;height:auto;min-height:60px}
        .month-tab{padding:0.5rem 1rem;margin:0.5rem;cursor:pointer;border-radius:25px;background:#e3f2fd;font-weight:500;font-size:0.9rem;transition:.3s}
        .month-tab.active{background:var(--secondary);color:#fff;transform:scale(1.05)}
        .month-tab:hover{background:#bbdefb;transform:scale(1.03)}
        .month-tab.nepali{font-family:'Noto Sans Devanagari',sans-serif}
        .nav-buttons{position:absolute;top:50%;transform:translateY(-50%);display:flex;gap:0.5rem}
        .nav-buttons.left{left:1rem}.nav-buttons.right{right:1rem}
        .nav-buttons button{background:#fff;color:var(--secondary);border:none;padding:0.5rem 1rem;border-radius:8px;cursor:pointer;font-weight:600;transition:.3s}
        .nav-buttons button:hover{background:var(--accent);color:var(--text)}
        .nav-buttons button:disabled{background:#ddd;cursor:not-allowed}
        .calendar-container{max-width:800px;margin:2rem auto;padding:1.5rem;background:var(--card-bg);border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,0.1);display:grid;grid-template-columns:90% 10%;gap:1rem}
        .main-calendar{width:100%;max-width:100%;margin:0}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:0.5rem;text-align:center;min-height:300px}
        .calendar-day{background:#fff;border:1px solid #e0e0e0;padding:0.75rem;cursor:pointer;min-height:100px;border-radius:8px;transition:.3s;position:relative;user-select:none}
        .calendar-day:hover{background:#f5f5f5;transform:translateY(-2px)}
        .calendar-day.today{background:#e3f2fd;border:2px solid var(--secondary)}
        .saturday{background:#b0bec5;color:#fff}.dashain{background:#d81b60;color:#fff}.tihar{background:#7b1fa2;color:#fff}
        .national{background:#4caf50;color:#fff}.ethnic{background:#ff9800;color:#fff}.women{background:#f06292;color:#fff}
        .education{background:#0288d1;color:#fff}.jatra{background:#ab47bc;color:#fff}.observed{background:#689f38;color:#fff}
        .disability{background:#26a69a;color:#fff}.birth{background:#ef6c00;color:#fff}
        .bs-date{font-weight:600;font-size:1rem;margin-bottom:0.2rem}
        .greg-date{font-size:0.7rem;color:var(--text-light);margin-bottom:0.2rem}
        .festival{font-size:0.65rem;margin-top:0.2rem;font-family:'Noto Sans Devanagari',sans-serif}
        .event-preview{font-size:0.6rem;color:var(--text-light);margin-top:0.2rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .festival-tooltip,.note-tooltip,.finance-tooltip{display:none;position:absolute;background:var(--text);color:#fff;padding:0.5rem;border-radius:6px;font-size:0.7rem;z-index:100;top:-2rem;left:50%;transform:translateX(-50%);white-space:nowrap}
        .calendar-day:hover .festival-tooltip,.calendar-day:hover .note-tooltip,.calendar-day:hover .finance-tooltip{display:block}
        .note-indicator,.income-indicator,.expense-indicator{position:absolute;top:0.4rem;right:0.4rem;width:8px;height:8px;border-radius:50%}
        .note-indicator{background:var(--secondary)}.income-indicator{background:var(--income)}.expense-indicator{background:var(--expense)}
        .footnote,.summary-section{margin-top:1rem;padding:1rem;background:var(--card-bg);border-top:1px solid #e0e0e0}
        .footnote h3,.summary-section h3{font-size:1rem;margin-bottom:0.5rem;color:var(--primary)}
        .footnote ul{list-style:none;font-size:0.8rem}.footnote li{margin-bottom:0.2rem}
        .footnote .nepali{font-family:'Noto Sans Devanagari',sans-serif}
        .summary-section p{font-size:0.9rem;color:var(--text)}
        .note-form-container{position:fixed;bottom:0;left:0;width:100%;background:var(--card-bg);box-shadow:0 -4px 12px rgba(0,0,0,0.1);padding:1.5rem;display:none;z-index:1000}
        .note-form-container.active{display:block}
        .note-form-container h3{margin:0 0 1rem;font-size:1.1rem;color:var(--primary)}
        .note-form-container select,.note-form-container input,.note-form-container textarea{width:100%;margin-bottom:1rem;padding:0.75rem;border:1px solid #ddd;border-radius:8px;font-family:'Poppins',sans-serif;font-size:0.9rem}
        .note-form-container select.nepali{font-family:'Noto Sans Devanagari',sans-serif}
        .note-form-container .form-buttons{display:flex;gap:0.75rem;justify-content:flex-end}
        .note-form-container button{background:var(--secondary);color:#fff;border:none;padding:0.75rem 1.5rem;border-radius:8px;cursor:pointer;font-weight:600;transition:.3s}
        .note-form-container button:hover{background:#0277bd}
        .note-form-container #closeEntry{background:#757575}
        .note-form-container #closeEntry:hover{background:#616161}
        .note-form-container #editEntry{background:#4caf50}
        .note-form-container #editEntry:hover{background:#388e3c}
        .note-form-container .nepali{font-family:'Noto Sans Devanagari',sans-serif}
        .notes-modal,.report-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:2000}
        .notes-modal-content,.report-modal-content{background:var(--card-bg);margin:5% auto;padding:1.5rem;width:90%;max-width:800px;border-radius:12px;position:relative}
        .notes-modal-content h2,.report-modal-content h2{margin:0 0 1rem;color:var(--primary);font-size:1.3rem}
        .notes-modal-content .nepali,.report-modal-content .nepali{font-family:'Noto Sans Devanagari',sans-serif}
        .close-modal{position:absolute;top:1rem;right:1rem;font-size:1.5rem;cursor:pointer;color:var(--text-light)}
        .filter-section,.report-tabs{margin-bottom:1rem}
        .filter-section select{padding:0.75rem;border-radius:8px;border:1px solid #ddd;width:100%;max-width:200px;font-family:'Poppins',sans-serif;font-size:0.9rem}
        .filter-section select.nepali{font-family:'Noto Sans Devanagari',sans-serif}
        .report-tabs{display:flex;gap:1rem}
        .report-tab{padding:0.5rem 1rem;cursor:pointer;border-radius:8px;background:#e3f2fd;font-weight:500;font-size:0.9rem;transition:.3s}
        .report-tab.active{background:var(--secondary);color:#fff}
        .report-tab:hover{background:#bbdefb}
        .notes-list,.finance-list,.report-content{max-height:400px;overflow-y:auto;margin-bottom:1rem}
        .note-item,.finance-item{border-bottom:1px solid #eee;padding:0.75rem 0;position:relative}
        .note-item:last-child,.finance-item:last-child{border-bottom:none}
        .note-actions{position:absolute;top:0.75rem;right:0;display:flex;gap:0.5rem}
        .edit-note,.delete-note{cursor:pointer;font-size:0.8rem}
        .edit-note{color:var(--secondary)}.edit-note:hover{color:#0277bd}
        .delete-note{color:var(--primary)}.delete-note:hover{color:#b71c1c}
        .action-buttons{display:flex;flex-direction:column;gap:0.75rem;justify-content:flex-start}
        .action-buttons button{background:var(--secondary);color:#fff;border:none;padding:0.75rem 0;border-radius:8px;cursor:pointer;font-weight:600;transition:.3s;width:100%;text-align:center}
        .action-buttons #addNote{background:#0288d1}
        .action-buttons #addNote:hover{background:#0277bd}
        .action-buttons #addFinance{background:#4caf50}
        .action-buttons #addFinance:hover{background:#388e3c}
        .year-filter{text-align:center;margin:1rem 0;display:flex;align-items:center;justify-content:center;gap:0.5rem}
        .year-filter select{padding:0.75rem;border-radius:8px;border:1px solid #ddd;font-family:'Poppins',sans-serif;font-size:0.9rem;background:#e3f2fd}
        .year-filter select:focus{outline:none;border-color:var(--secondary)}
        .year-filter button{background:var(--secondary);color:#fff;border:none;padding:0.75rem 1rem;border-radius:8px;cursor:pointer;font-family:'Poppins',sans-serif;font-size:0.9rem;transition:.3s}
        .year-filter button:hover{background:#0277bd}
        .year-filter .notes-btn{background:#0288d1}
        .year-filter .notes-btn:hover{background:#0277bd}
        .year-filter .finance-btn{background:#4caf50}
        .year-filter .finance-btn:hover{background:#388e3c}
        .year-filter .backup-btn{background:#ff9800}
        .year-filter .backup-btn:hover{background:#fb8c00}
        .year-filter .restore-btn{background:#ab47bc}
        .year-filter .restore-btn:hover{background:#9c27b0}
        .year-filter .excel-btn{background:#388e3c}
        .year-filter .excel-btn:hover{background:#2e7d32}
        .year-filter .pdf-btn{background:#d32f2f}
        .year-filter .pdf-btn:hover{background:#b71c1c}
        .year-filter .import-btn{background:#0288d1}
        .year-filter .import-btn:hover{background:#0277bd}
        .year-filter button.nepali{font-family:'Noto Sans Devanagari',sans-serif}
        .today-date-row{text-align:center;margin:0.5rem 0;font-size:1rem;color:var(--text);display:flex;justify-content:center;gap:2rem}
        .blink{animation:blink 1s infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
        .today-date-row .nepali{font-family:'Noto Sans Devanagari',sans-serif}
        .footer{text-align:center;padding:1rem;background:var(--card-bg);color:var(--text-light);font-size:0.8rem;margin-top:2rem;box-shadow:0 -2px 8px rgba(0,0,0,0.1)}
        .report-table{width:100%;border-collapse:collapse;margin-bottom:1rem}
        .report-table th,.report-table td{border:1px solid #ddd;padding:0.5rem;text-align:left;font-size:0.9rem}
        .report-table th{background:var(--secondary);color:#fff}
        .weekday-header{background:var(--secondary);color:#fff;padding:0.5rem;font-weight:600}
        .dropdown{position:relative;display:inline-block}
        .dropdown-content{display:none;position:absolute;background-color:var(--card-bg);min-width:160px;box-shadow:0 8px 16px rgba(0,0,0,0.2);z-index:1;border-radius:8px;overflow:hidden}
        .dropdown-content div{padding:0.75rem 1rem;cursor:pointer;font-size:0.9rem;color:var(--text);transition:.3s}
        .dropdown-content div:hover{background-color:#e3f2fd}
        .dropdown-content div.nepali{font-family:'Noto Sans Devanagari',sans-serif}
        .dropdown:hover .dropdown-content{display:block}
        .search-bar{margin-bottom:1rem;padding:0.75rem;border:1px solid #ddd;border-radius:8px;width:100%;font-family:'Poppins',sans-serif}
        .category-manager{margin-top:1rem}
        .category-manager input{padding:0.75rem;border:1px solid #ddd;border-radius:8px;width:70%;margin-right:0.5rem}
        .category-manager button{background:#4caf50;color:#fff;border:none;padding:0.75rem;border-radius:8px;cursor:pointer}
        .category-manager button:hover{background:#388e3c}
        @media (max-width:768px){
            .header{font-size:1.2rem}
            .month-tab{padding:0.4rem 0.8rem;font-size:0.8rem}
            .calendar-day{min-height:80px}
            .nav-buttons{flex-direction:column}
            .calendar-container{grid-template-columns:1fr;grid-template-rows:auto auto;gap:1rem}
            .main-calendar{max-width:100%}
            .action-buttons{flex-direction:row;justify-content:space-between}
            .action-buttons button{padding:0.5rem}
            .notes-modal-content,.report-modal-content{margin:10% auto;width:95%}
            .year-filter{flex-direction:column}
            .today-date-row{flex-direction:column;gap:0.5rem}
            .note-form-container .form-buttons{flex-direction:column}
            .dropdown-content{min-width:120px}
        }
    </style>
</head>
<body>
    <div class="header">
        <span class="header-title" data-en="Nepali Calendar" data-ne="नेपाली पात्रो">Nepali Calendar</span> - <span id="currentMonth">2082 BS</span>
        <div class="nav-buttons left">
            <button id="prevMonth" data-en="Previous" data-ne="अघिल्लो" aria-label="Previous Month">Previous</button>
        </div>
        <div class="nav-buttons right">
            <button id="nextMonth" data-en="Next" data-ne="पछिल्लो" aria-label="Next Month">Next</button>
        </div>
    </div>
    <div class="year-filter">
        <select id="yearFilter" aria-label="Select Year">
            <option value="2081">2081 BS</option>
            <option value="2082" selected>2082 BS</option>
            <option value="2083">2083 BS</option>
        </select>
        <button id="todayButton" data-en="Today" data-ne="आज" aria-label="Go to Today">Today</button>
        <button id="viewNotes" class="notes-btn" data-en="View Notes" data-ne="नोटहरू हेर्नुहोस्" aria-label="View Notes">View Notes</button>
        <button id="viewFinance" class="finance-btn" data-en="View Finances" data-ne="वित्त हेर्नुहोस्" aria-label="View Finances">View Finances</button>
        <button id="backupData" class="backup-btn" data-en="Backup" data-ne="ब्याकअप" aria-label="Backup Data">Backup</button>
        <button id="restoreData" class="restore-btn" data-en="Restore" data-ne="पुनर्स्थापना" aria-label="Restore Data">Restore</button>
        <div class="dropdown">
            <button class="excel-btn" data-en="Excel Export" data-ne="एक्सेल निर्यात" aria-label="Excel Export">Excel Export</button>
            <div class="dropdown-content">
                <div class="excel-option" data-type="note" data-en="Notes" data-ne="नोटहरू">Notes</div>
                <div class="excel-option" data-type="finance" data-en="Finances" data-ne="वित्त">Finances</div>
                <div class="excel-option" data-type="calendar" data-en="Monthly Calendar" data-ne="मासिक पात्रो">Monthly Calendar</div>
            </div>
        </div>
        <div class="dropdown">
            <button class="pdf-btn" data-en="PDF Export" data-ne="PDF निर्यात" aria-label="PDF Export">PDF Export</button>
            <div class="dropdown-content">
                <div class="pdf-option" data-type="note" data-en="Notes" data-ne="नोटहरू">Notes</div>
                <div class="pdf-option" data-type="finance" data-en="Finances" data-ne="वित्त">Finances</div>
                <div class="pdf-option" data-type="calendar" data-en="Monthly Calendar" data-ne="मासिक पात्रो">Monthly Calendar</div>
            </div>
        </div>
        <div class="dropdown">
            <button class="import-btn" data-en="Import" data-ne="आयात" aria-label="Import Data">Import</button>
            <div class="dropdown-content">
                <div class="import-option" data-type="note" data-en="Notes" data-ne="नोटहरू">Notes</div>
                <div class="import-option" data-type="finance" data-en="Finances" data-ne="वित्त">Finances</div>
                <div class="import-option" data-type="calendar" data-en="Monthly Calendar" data-ne="मासिक पात्रो">Monthly Calendar</div>
                <div class="import-option" data-type="holiday" data-en="Yearly Holiday" data-ne="वार्षिक बिदा">Yearly Holiday</div>
            </div>
        </div>
        <input type="file" id="restoreFileInput" style="display:none" accept=".json" aria-label="File Input for Restore">
        <button id="undoAction" data-en="Undo" data-ne="पुर्ववत" aria-label="Undo Last Action" style="background:#ff9800">Undo</button>
    </div>
    <div class="today-date-row">
        <span id="todayNepaliDate" class="blink"></span>
        <span id="todayEnglishDate" class="blink"></span>
    </div>
    <div class="month-tabs" id="monthTabs"></div>
    <div class="language-toggle">
        <button id="languageToggle" data-en="Toggle Language (EN/NE)" data-ne="भाषा टगल गर्नुहोस् (EN/NE)" aria-label="Toggle Language">Toggle Language (EN/NE)</button>
    </div>
    <div class="calendar-container">
        <div class="main-calendar">
            <div class="calendar-grid" id="calendarGrid" role="grid" aria-label="Calendar"></div>
            <div class="summary-section">
                <h3 data-en="Monthly Summary" data-ne="मासिक सारांश">Monthly Summary</h3>
                <p id="monthlySummary"></p>
            </div>
            <div class="footnote">
                <h3 data-en="Holidays this Month" data-ne="यस महिनाका बिदाहरू">Holidays this Month</h3>
                <ul id="holidayList"></ul>
            </div>
        </div>
        <div class="action-buttons">
            <button id="addNote" data-en="Add Note" data-ne="नोट थप्नुहोस्" aria-label="Add Note">Add Note</button>
            <button id="addFinance" data-en="Add Finance" data-ne="वित्त थप्नुहोस्" aria-label="Add Finance">Add Finance</button>
        </div>
    </div>
    <div class="note-form-container" id="noteForm" role="dialog" aria-labelledby="noteFormTitle">
        <h3 id="noteFormTitle"><span data-en="Add Entry for" data-ne="प्रवेश थप्नुहोस्">Add Entry for</span> <span id="selectedDate">Date</span></h3>
        <select id="entryType" aria-label="Entry Type">
            <option value="note" data-en="Note" data-ne="नोट">Note</option>
            <option value="income" data-en="Income" data-ne="आय">Income</option>
            <option value="expense" data-en="Expense" data-ne="खर्च">Expense</option>
        </select>
        <input type="text" id="noteTitle" placeholder="Note Title / Amount" data-en="Note Title / Amount" data-ne="नोट शीर्षक / रकम" aria-label="Note Title or Amount">
        <input type="time" id="noteTime" aria-label="Note Time">
        <textarea id="noteDescription" placeholder="Description" data-en="Description" data-ne="विवरण" rows="3" aria-label="Description"></textarea>
        <select id="entryCategory" style="display:none" aria-label="Category">
            <option value="" data-en="Select Category" data-ne="श्रेणी चयन गर्नुहोस्">Select Category</option>
            <option value="Food" data-en="Food" data-ne="खाना">Food</option>
            <option value="Salary" data-en="Salary" data-ne="तलब">Salary</option>
            <option value="Rent" data-en="Rent" data-ne="भाडा">Rent</option>
            <option value="Utilities" data-en="Utilities" data-ne="उपयोगिताहरू">Utilities</option>
            <option value="Transport" data-en="Transport" data-ne="यातायात">Transport</option>
            <option value="Entertainment" data-en="Entertainment" data-ne="मनोरञ्जन">Entertainment</option>
            <option value="Freelance" data-en="Freelance" data-ne="फ्रीलान्स">Freelance</option>
            <option value="Other" data-en="Other" data-ne="अन्य">Other</option>
        </select>
        <div class="category-manager" id="categoryManager" style="display:none">
            <input type="text" id="newCategory" placeholder="New Category" data-en="New Category" data-ne="नयाँ श्रेणी" aria-label="New Category">
            <button id="addCategory" data-en="Add Category" data-ne="श्रेणी थप्नुहोस्" aria-label="Add Category">Add Category</button>
        </div>
        <label><input type="checkbox" id="recurring" aria-label="Recurring Monthly"> <span data-en="Recurring Monthly" data-ne="मासिक दोहोरिने">Recurring Monthly</span></label>
        <label><input type="checkbox" id="reminder" aria-label="Set Reminder"> <span data-en="Set Reminder" data-ne="रिमाइन्डर सेट गर्नुहोस्">Set Reminder</span></label>
        <div class="form-buttons">
            <button id="saveNote" data-en="Save Entry" data-ne="प्रवेश बचत गर्नुहोस्" aria-label="Save Entry">Save Entry</button>
            <button id="editEntry" data-en="Edit Entry" data-ne="प्रवेश सम्पादन गर्नुहोस्" aria-label="Edit Entry">Edit Entry</button>
            <button id="closeEntry" data-en="Close Entry" data-ne="प्रवेश बन्द गर्नुहोस्" aria-label="Close Entry">Close Entry</button>
        </div>
    </div>
    <div class="notes-modal" id="notesModal" role="dialog" aria-labelledby="notesModalTitle">
        <div class="notes-modal-content">
            <span class="close-modal" id="closeModal" aria-label="Close Notes Modal">×</span>
            <h2 id="notesModalTitle" data-en="Saved Notes" data-ne="बचत गरिएका नोटहरू">Saved Notes</h2>
            <div class="filter-section">
                <input type="text" id="noteSearch" class="search-bar" placeholder="Search Notes" data-en="Search Notes" data-ne="नोटहरू खोज्नुहोस्" aria-label="Search Notes">
                <select id="monthFilter" aria-label="Filter by Month">
                    <option value="all" data-en="All Months" data-ne="सबै महिनाहरू">All Months</option>
                </select>
            </div>
            <div class="notes-list" id="notesList"></div>
            <div class="action-buttons">
                <button class="clear-btn" id="clearNotes" data-en="Clear All Notes" data-ne="सबै नोटहरू मेटाउनुहोस्" aria-label="Clear All Notes">Clear All Notes</button>
            </div>
        </div>
    </div>
    <div class="report-modal" id="reportModal" role="dialog" aria-labelledby="reportModalTitle">
        <div class="report-modal-content">
            <span class="close-modal" id="closeReportModal" aria-label="Close Report Modal">×</span>
            <h2 id="reportModalTitle" data-en="Financial Reports" data-ne="वित्तीय रिपोर्टहरू">Financial Reports</h2>
            <div class="filter-section">
                <input type="text" id="financeSearch" class="search-bar" placeholder="Search Finances" data-en="Search Finances" data-ne="वित्त खोज्नुहोस्" aria-label="Search Finances">
            </div>
            <div class="report-tabs">
                <div class="report-tab active" id="weeklyReportTab" data-en="Weekly" data-ne="साप्ताहिक" role="tab" aria-selected="true">Weekly</div>
                <div class="report-tab" id="monthlyReportTab" data-en="Monthly" data-ne="मासिक" role="tab" aria-selected="false">Monthly</div>
                <div class="report-tab" id="yearlyReportTab" data-en="Yearly" data-ne="वार्षिक" role="tab" aria-selected="false">Yearly</div>
                <div class="report-tab" id="recordsReportTab" data-en="Records" data-ne="रेकर्डहरू" role="tab" aria-selected="false">Records</div>
            </div>
            <div class="report-content" id="reportContent"></div>
        </div>
    </div>
    <div class="footer">Calendar Concept and Design by Santosh Phuyal</div>
    <script nonce="OGY1ZmVhYWEtOGRlNy00YjRhLTk4NzEtNjY2OWU2MGNiN2Y2" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script nonce="OGY1ZmVhYWEtOGRlNy00YjRhLTk4NzEtNjY2OWU2MGNiN2Y2" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script nonce="OGY1ZmVhYWEtOGRlNy00YjRhLTk4NzEtNjY2OWU2MGNiN2Y2">
        // Calendar data
        const calendarData = {
            2081: [
                {name:"Baishakh",days:31,gregStart:"2024-04-13"},
                {name:"Jestha",days:32,gregStart:"2024-05-14"},
                {name:"Ashadh",days:31,gregStart:"2024-06-15"},
                {name:"Shrawan",days:32,gregStart:"2024-07-16"},
                {name:"Bhadra",days:31,gregStart:"2024-08-17"},
                {name:"Asoj",days:31,gregStart:"2024-09-17"},
                {name:"Kartik",days:30,gregStart:"2024-10-18"},
                {name:"Mangsir",days:29,gregStart:"2024-11-17"},
                {name:"Poush",days:30,gregStart:"2024-12-16"},
                {name:"Magh",days:29,gregStart:"2025-01-15"},
                {name:"Falgun",days:30,gregStart:"2025-02-13"},
                {name:"Chaitra",days:30,gregStart:"2025-03-15"}
            ],
            2082: [
                {name:"Baishakh",days:31,gregStart:"2025-04-14"},
                {name:"Jestha",days:31,gregStart:"2025-05-15"},
                {name:"Ashadh",days:32,gregStart:"2025-06-15"},
                {name:"Shrawan",days:31,gregStart:"2025-07-17"},
                {name:"Bhadra",days:31,gregStart:"2025-08-17"},
                {name:"Asoj",days:31,gregStart:"2025-09-17"},
                {name:"Kartik",days:30,gregStart:"2025-10-18"},
                {name:"Mangsir",days:29,gregStart:"2025-11-17"},
                {name:"Poush",days:30,gregStart:"2025-12-16"},
                {name:"Magh",days:29,gregStart:"2026-01-15"},
                {name:"Falgun",days:30,gregStart:"2026-02-13"},
                {name:"Chaitra",days:31,gregStart:"2026-03-16"}
            ],
            2083: [
                {name:"Baishakh",days:31,gregStart:"2026-04-14"},
                {name:"Jestha",days:32,gregStart:"2026-05-15"},
                {name:"Ashadh",days:31,gregStart:"2026-06-16"},
                {name:"Shrawan",days:31,gregStart:"2026-07-17"},
                {name:"Bhadra",days:31,gregStart:"2026-08-17"},
                {name:"Asoj",days:30,gregStart:"2026-09-17"},
                {name:"Kartik",days:30,gregStart:"2026-10-17"},
                {name:"Mangsir",days:30,gregStart:"2026-11-16"},
                {name:"Poush",days:29,gregStart:"2026-12-16"},
                {name:"Magh",days:30,gregStart:"2027-01-14"},
                {name:"Falgun",days:30,gregStart:"2027-02-13"},
                {name:"Chaitra",days:31,gregStart:"2027-03-15"}
            ]
        };

        // Holidays data
        const holidays = {
            2081: [
                { month: 6, day: 1, name: "Dashain", nepali: "दशैं", type: "dashain" },
                { month: 6, day: 15, name: "Tihar", nepali: "तिहार", type: "tihar" },
                { month: 11, day: 1, name: "Chaitra Navaratri", nepali: "चैत्र नवरात्री", type: "national" }
            ],
            2082: [
                { month: 0, day: 1, name: "Nepali New Year", nepali: "नेपाली नयाँ वर्ष", type: "national" },
                { month: 0, day: 5, name: "Ram Navami", nepali: "राम नवमी", type: "national" },
                { month: 0, day: 29, name: "Ubauli Parva", nepali: "उबौली पर्व", type: "ethnic" },
                { month: 0, day: 29, name: "Buddha Jayanti", nepali: "बुद्ध जयन्ती", type: "birth" },
                { month: 0, day: 18, name: "May Day Labour Day", nepali: "मे दिवस", type: "observed" },
                { month: 1, day: 15, name: "Republic Day", nepali: "गणतन्त्र दिवस", type: "observed" },
                { month: 3, day: 24, name: "Rakshya Bandhan", nepali: "रक्षा बन्धन", type: "national" },
                { month: 3, day: 25, name: "Gai Jatra", nepali: "गाईजात्रा", type: "jatra" },
                { month: 3, day: 25, name: "Gaijatra", nepali: "गाईजात्रा", type: "ethnic" },
                { month: 3, day: 31, name: "Krishna Janmashtami", nepali: "कृष्ण जन्माष्टमी", type: "national" },
                { month: 4, day: 10, name: "Haritalika (Teej)", nepali: "हरितालिका (तीज)", type: "women" },
                { month: 4, day: 15, name: "Gaura Parva", nepali: "गौरा पर्व", type: "ethnic" },
                { month: 4, day: 21, name: "Indra Jatra", nepali: "इन्द्रजात्रा", type: "jatra" },
                { month: 4, day: 30, name: "Jitiya Festival", nepali: "जितिया पर्व", type: "women" },
                { month: 5, day: 3, name: "Constitution Day", nepali: "संविधान दिवस", type: "observed" },
                { month: 5, day: 6, name: "Ghatasthapana", nepali: "घटस्थापना", type: "national" },
                { month: 5, day: 13, name: "Dashain", nepali: "दशैं", type: "dashain" },
                { month: 5, day: 14, name: "Dashain", nepali: "दशैं", type: "dashain" },
                { month: 5, day: 15, name: "Dashain", nepali: "दशैं", type: "dashain" },
                { month: 5, day: 16, name: "Dashain", nepali: "दशैं", type: "dashain" },
                { month: 5, day: 17, name: "Dashain", nepali: "दशैं", type: "dashain" },
                { month: 5, day: 18, name: "Dashain", nepali: "दशैं", type: "dashain" },
                { month: 6, day: 3, name: "Tihar", nepali: "तिहार", type: "tihar" },
                { month: 6, day: 4, name: "Tihar", nepali: "तिहार", type: "tihar" },
                { month: 6, day: 5, name: "Tihar", nepali: "तिहार", type: "tihar" },
                { month: 6, day: 6, name: "Tihar", nepali: "तिहार", type: "tihar" },
                { month: 6, day: 7, name: "Tihar", nepali: "तिहार", type: "tihar" },
                { month: 6, day: 10, name: "Chhath", nepali: "छठ", type: "national" },
                { month: 6, day: 25, name: "Falgunanda Jayanti", nepali: "फाल्गुनन्द जयन्ती", type: "birth" },
                { month: 7, day: 17, name: "International Day of Persons with Disabilities", nepali: "अन्तर्राष्ट्रिय अपाङ्गता दिवस", type: "disability" },
                { month: 7, day: 18, name: "Udhauli Parva, Yomari Punhi", nepali: "उधौली पर्व, योमरी पुन्ही", type: "national" },
                { month: 8, day: 10, name: "Christmas", nepali: "क्रिसमस", type: "national" },
                { month: 8, day: 15, name: "Tamu Lhosar", nepali: "तमु ल्होसार", type: "national" },
                { month: 8, day: 27, name: "Prithvi Jayanti", nepali: "पृथ्वी जयन्ती", type: "birth" },
                { month: 9, day: 1, name: "Maghi Parva/Maghe Sankranti", nepali: "माघी पर्व/माघे संक्रान्ति", type: "national" },
                { month: 9, day: 5, name: "Sonam Lhosar", nepali: "सोनाम ल्होसार", type: "national" },
                { month: 9, day: 9, name: "Basanta Panchami/Saraswati Puja", nepali: "बसन्त पञ्चमी/सरस्वती पूजा", type: "education" },
                { month: 9, day: 16, name: "Martyrs Day", nepali: "शहीद दिवस", type: "observed" },
                { month: 10, day: 3, name: "Maha Shivaratri", nepali: "महाशिवरात्रि", type: "national" },
                { month: 10, day: 6, name: "Gyalpo Lhosar", nepali: "ग्याल्पो ल्होसार", type: "national" },
                { month: 10, day: 7, name: "Democracy Day", nepali: "प्रजातन्त्र दिवस", type: "observed" },
                { month: 10, day: 18, name: "Fagu Purnima", nepali: "फागु पूर्णिमा", type: "national" },
                { month: 10, day: 24, name: "International Women's Day", nepali: "अन्तर्राष्ट्रिय महिला दिवस", type: "observed" },
                { month: 11, day: 1, name: "Fagu Purnima", nepali: "फागु पूर्णिमा", type: "national" },
                { month: 11, day: 4, name: "Ghode Jatra", nepali: "घोडेजात्रा", type: "jatra" }
            ],
            2083: [
                { month: 0, day: 1, name: "Nepali New Year", nepali: "नेपाली नयाँ वर्ष", type: "national" },
                { month: 5, day: 15, name: "Dashain", nepali: "दशैं", type: "dashain" },
                { month: 5, day: 29, name: "Tihar", nepali: "तिहार", type: "tihar" }
            ]
        };

        // Initialize state
        let currentYear = 2082;
        let currentMonthIndex = 0;
        let isNepali = false;
        let notes = JSON.parse(localStorage.getItem('notes')) || [];
        let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
        let editingNoteIndex = null;
        let undoStack = [];

        // Language data
        const monthsNepali = ['बैशाख', 'जेठ', 'असार', 'श्रावण', 'भदौ', 'आश्विन', 'कार्तिक', 'मंसिर', 'पौष', 'माघ', 'फाल्गुन', 'चैत'];
        const daysNepali = ['आइतबार', 'सोमबार', 'मंगलबार', 'बुधबार', 'बिहीबार', 'शुक्रबार', 'शनिबार'];
        const daysEnglish = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // DOM elements
        const monthTabs = document.getElementById('monthTabs');
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonth = document.getElementById('currentMonth');
        const prevMonth = document.getElementById('prevMonth');
        const nextMonth = document.getElementById('nextMonth');
        const yearFilter = document.getElementById('yearFilter');
        const todayButton = document.getElementById('todayButton');
        const viewNotes = document.getElementById('viewNotes');
        const viewFinance = document.getElementById('viewFinance');
        const backupData = document.getElementById('backupData');
        const restoreData = document.getElementById('restoreData');
        const restoreFileInput = document.getElementById('restoreFileInput');
        const languageToggle = document.getElementById('languageToggle');
        const noteForm = document.getElementById('noteForm');
        const entryType = document.getElementById('entryType');
        const noteTitle = document.getElementById('noteTitle');
        const noteTime = document.getElementById('noteTime');
        const noteDescription = document.getElementById('noteDescription');
        const entryCategory = document.getElementById('entryCategory');
        const newCategory = document.getElementById('newCategory');
        const addCategory = document.getElementById('addCategory');
        const categoryManager = document.getElementById('categoryManager');
        const recurring = document.getElementById('recurring');
        const reminder = document.getElementById('reminder');
        const saveNote = document.getElementById('saveNote');
        const editEntry = document.getElementById('editEntry');
        const closeEntry = document.getElementById('closeEntry');
        const selectedDate = document.getElementById('selectedDate');
        const notesModal = document.getElementById('notesModal');
        const closeModal = document.getElementById('closeModal');
        const noteSearch = document.getElementById('noteSearch');
        const notesList = document.getElementById('notesList');
        const monthFilter = document.getElementById('monthFilter');
        const clearNotes = document.getElementById('clearNotes');
        const reportModal = document.getElementById('reportModal');
        const closeReportModal = document.getElementById('closeReportModal');
        const financeSearch = document.getElementById('financeSearch');
        const reportContent = document.getElementById('reportContent');
        const weeklyReportTab = document.getElementById('weeklyReportTab');
        const monthlyReportTab = document.getElementById('monthlyReportTab');
        const yearlyReportTab = document.getElementById('yearlyReportTab');
        const recordsReportTab = document.getElementById('recordsReportTab');
        const monthlySummary = document.getElementById('monthlySummary');
        const holidayList = document.getElementById('holidayList');
        const todayNepaliDate = document.getElementById('todayNepaliDate');
        const todayEnglishDate = document.getElementById('todayEnglishDate');
        const addNote = document.getElementById('addNote');
        const addFinance = document.getElementById('addFinance');
        const undoAction = document.getElementById('undoAction');

        // Utility functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), wait);
            };
        }

        function getBSDateFromGregorian(date) {
            try {
                for (let year in calendarData) {
                    for (let i = 0; i < calendarData[year].length; i++) {
                        let month = calendarData[year][i];
                        let startDate = new Date(month.gregStart);
                        let endDate = new Date(startDate);
                        endDate.setDate(startDate.getDate() + month.days - 1);
                        if (date >= startDate && date <= endDate) {
                            let dayDiff = Math.floor((date - startDate) / (1000 * 60 * 60 * 24)) + 1;
                            return { year: parseInt(year), month: i, day: dayDiff };
                        }
                    }
                }
                return null;
            } catch (err) {
                console.error('Error in getBSDateFromGregorian:', err);
                return null;
            }
        }

        function getGregorianDate(year, monthIndex, day) {
            try {
                let month = calendarData[year][monthIndex];
                let startDate = new Date(month.gregStart);
                startDate.setDate(startDate.getDate() + day - 1);
                return startDate;
            } catch (err) {
                console.error('Error in getGregorianDate:', err);
                return new Date();
            }
        }

        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getRecurringDates(note) {
            if (!note.recurring) return [note.date];
            let dates = [];
            let [startYear, startMonth, startDay] = note.date.split('-').map(Number);
            startMonth--; // Adjust for 0-based index
            for (let year = startYear; year <= 2083; year++) {
                for (let month = (year === startYear ? startMonth : 0); month < 12; month++) {
                    if (calendarData[year][month].days >= startDay) {
                        dates.push(`${year}-${String(month + 1).padStart(2, '0')}-${String(startDay).padStart(2, '0')}`);
                    }
                }
            }
            return dates;
        }

        function checkReminders() {
            if (!("Notification" in window) || Notification.permission !== "granted") return;
            let today = new Date();
            let bsDate = getBSDateFromGregorian(today);
            if (!bsDate) return;
            let dateStr = `${bsDate.year}-${String(bsDate.month + 1).padStart(2, '0')}-${String(bsDate.day).padStart(2, '0')}`;
            notes.forEach(note => {
                if (note.reminder && getRecurringDates(note).includes(dateStr)) {
                    new Notification(note.title, {
                        body: note.description || (isNepali ? 'आजको लागि रिमाइन्डर' : 'Reminder for today'),
                        icon: '/path/to/icon.png'
                    });
                }
            });
            let holiday = holidays[bsDate.year]?.find(h => h.month === bsDate.month && h.day === bsDate.day);
            if (holiday) {
                new Notification(isNepali ? holiday.nepali : holiday.name, {
                    body: isNepali ? 'आजको बिदा' : 'Today\'s holiday',
                    icon: '/path/to/icon.png'
                });
            }
        }

        // Rendering functions
        function renderMonthTabs() {
            const fragment = document.createDocumentFragment();
            calendarData[currentYear].forEach((month, index) => {
                let tab = document.createElement('div');
                tab.classList.add('month-tab');
                tab.setAttribute('role', 'tab');
                tab.setAttribute('aria-selected', index === currentMonthIndex);
                if (index === currentMonthIndex) tab.classList.add('active');
                if (isNepali) {
                    tab.classList.add('nepali');
                    tab.textContent = monthsNepali[index];
                } else {
                    tab.textContent = month.name;
                }
                tab.addEventListener('click', () => {
                    currentMonthIndex = index;
                    renderCalendar();
                    renderMonthTabs();
                });
                fragment.appendChild(tab);
            });
            monthTabs.innerHTML = '';
            monthTabs.appendChild(fragment);
        }

        function renderCalendar() {
            let month = calendarData[currentYear][currentMonthIndex];
            if (!month) return;
            currentMonth.textContent = isNepali 
                ? `${monthsNepali[currentMonthIndex]} ${currentYear} BS` 
                : `${month.name} ${currentYear} BS`;
            const fragment = document.createDocumentFragment();

            const weekdays = isNepali ? daysNepali : daysEnglish;
            weekdays.forEach(day => {
                let dayHeader = document.createElement('div');
                dayHeader.classList.add('weekday-header');
                dayHeader.textContent = day;
                fragment.appendChild(dayHeader);
            });

            let startDate = new Date(month.gregStart);
            let firstDay = startDate.getDay();
            let today = new Date();
            let todayBS = getBSDateFromGregorian(today);

            for (let i = 0; i < firstDay; i++) {
                let emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day');
                fragment.appendChild(emptyDay);
            }

            for (let day = 1; day <= month.days; day++) {
                let gregDate = getGregorianDate(currentYear, currentMonthIndex, day);
                let dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day');
                dayDiv.setAttribute('role', 'gridcell');
                dayDiv.setAttribute('tabindex', '0');
                if (todayBS && todayBS.year === currentYear && todayBS.month === currentMonthIndex && todayBS.day === day) {
                    dayDiv.classList.add('today');
                }
                if (gregDate.getDay() === 6) {
                    dayDiv.classList.add('saturday');
                }

                let holiday = holidays[currentYear]?.find(h => h.month === currentMonthIndex && h.day === day);
                if (holiday) {
                    dayDiv.classList.add(holiday.type);
                    let festivalDiv = document.createElement('div');
                    festivalDiv.classList.add('festival');
                    festivalDiv.textContent = isNepali ? holiday.nepali : holiday.name;
                    dayDiv.appendChild(festivalDiv);

                    let tooltip = document.createElement('div');
                    tooltip.classList.add('festival-tooltip');
                    tooltip.textContent = isNepali ? holiday.nepali : holiday.name;
                    dayDiv.appendChild(tooltip);
                }

                let bsDate = document.createElement('div');
                bsDate.classList.add('bs-date');
                bsDate.textContent = isNepali ? (day).toString() : day;
                dayDiv.appendChild(bsDate);

                let gregDateDiv = document.createElement('div');
                gregDateDiv.classList.add('greg-date');
                gregDateDiv.textContent = gregDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                dayDiv.appendChild(gregDateDiv);

                let dateStr = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let dayNotes = notes.filter(note => getRecurringDates(note).includes(dateStr));
                dayNotes.forEach(note => {
                    let indicator = document.createElement('div');
                    let tooltip = document.createElement('div');
                    let preview = document.createElement('div');
                    preview.classList.add('event-preview');
                    if (note.type === 'note') {
                        indicator.classList.add('note-indicator');
                        tooltip.classList.add('note-tooltip');
                        tooltip.textContent = note.title;
                        preview.textContent = note.title.substring(0, 15) + (note.title.length > 15 ? '...' : '');
                    } else if (note.type === 'income') {
                        indicator.classList.add('income-indicator');
                        tooltip.classList.add('finance-tooltip');
                        tooltip.textContent = `Income: ${note.title} NPR`;
                        preview.textContent = `+${note.title} NPR`;
                    } else if (note.type === 'expense') {
                        indicator.classList.add('expense-indicator');
                        tooltip.classList.add('finance-tooltip');
                        tooltip.textContent = `Expense: ${note.title} NPR`;
                        preview.textContent = `-${note.title} NPR`;
                    }
                    dayDiv.appendChild(indicator);
                    dayDiv.appendChild(tooltip);
                    dayDiv.appendChild(preview);
                });

                dayDiv.addEventListener('click', () => {
                    selectedDate.textContent = dateStr;
                    noteForm.classList.add('active');
                    entryType.value = 'note';
                    noteTitle.value = '';
                    noteTime.value = '';
                    noteDescription.value = '';
                    recurring.checked = false;
                    reminder.checked = false;
                    entryCategory.style.display = 'none';
                    categoryManager.style.display = 'none';
                    saveNote.style.display = 'block';
                    editEntry.style.display = 'none';
                    noteTitle.focus();
                });

                dayDiv.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        dayDiv.click();
                    }
                });

                fragment.appendChild(dayDiv);
            }

            calendarGrid.innerHTML = '';
            calendarGrid.appendChild(fragment);
            renderMonthlySummary();
            renderHolidays();
        }

        function renderMonthlySummary() {
            let income = 0, expense = 0;
            let dateStr = `${currentYear}-${String(currentMonthIndex + 1).padStart(2, '0')}`;
            let monthNotes = notes.filter(note => getRecurringDates(note).some(d => d.startsWith(dateStr)) && (note.type === 'income' || note.type === 'expense'));
            monthNotes.forEach(note => {
                if (note.type === 'income') income += parseFloat(note.title || 0);
                else expense += parseFloat(note.title || 0);
            });
            monthlySummary.innerHTML = isNepali
                ? `कुल आय: ${income} NPR<br>कुल खर्च: ${expense} NPR<br>ब्यालेन्स: ${income - expense} NPR`
                : `Total Income: ${income} NPR<br>Total Expense: ${expense} NPR<br>Balance: ${income - expense} NPR`;
        }

        function renderHolidays() {
            const fragment = document.createDocumentFragment();
            let monthHolidays = holidays[currentYear]?.filter(h => h.month === currentMonthIndex) || [];
            if (monthHolidays.length === 0) {
                let li = document.createElement('li');
                li.textContent = isNepali ? 'यस महिनामा कुनै बिदा छैन' : 'No holidays this month';
                fragment.appendChild(li);
            } else {
                monthHolidays.forEach(holiday => {
                    let li = document.createElement('li');
                    li.textContent = `${isNepali ? holiday.nepali : holiday.name} - ${holiday.day} ${isNepali ? monthsNepali[currentMonthIndex] : calendarData[currentYear][currentMonthIndex].name}`;
                    if (isNepali) li.classList.add('nepali');
                    fragment.appendChild(li);
                });
            }
            holidayList.innerHTML = '';
            holidayList.appendChild(fragment);
        }

        function toggleLanguage() {
            isNepali = !isNepali;
            document.querySelectorAll('[data-en]').forEach(elem => {
                elem.textContent = isNepali ? elem.dataset.ne : elem.dataset.en;
            });
            renderMonthTabs();
            renderCalendar();
            renderNotesList();
            renderFinancialRecords();
            renderReport('weekly');
        }

        function saveEntry() {
            let date = selectedDate.textContent;
            let type = entryType.value;
            let title = noteTitle.value.trim();
            let time = noteTime.value;
            let description = noteDescription.value.trim();
            let category = entryCategory.value;
            let isRecurring = recurring.checked;
            let hasReminder = reminder.checked;

            if (!title) {
                alert(isNepali ? 'शीर्षक / रकम आवश्यक छ' : 'Title / Amount is required');
                return;
            }

            if (type !== 'note' && (isNaN(parseFloat(title)) || parseFloat(title) <= 0)) {
                alert(isNepali ? 'रकम सकारात्मक संख्या हुनुपर्छ' : 'Amount must be a positive number');
                return;
            }

            let note = { date, type, title, time, description, category, recurring: isRecurring, reminder: hasReminder };
            notes.push(note);

            try {
                localStorage.setItem('notes', JSON.stringify(notes));
            } catch (e) {
                alert(isNepali ? 'नोट बचत गर्न असफल: भण्डारण सीमा नाघ्यो' : 'Failed to save note: Storage limit exceeded');
                notes.pop();
                return;
            }

            noteForm.classList.remove('active');
            renderCalendar();
            renderNotesList();
            renderFinancialRecords();
            renderMonthlySummary();
        }

        function editNote(index) {
            let note = notes[index];
            if (!note) {
                alert(isNepali ? 'नोट फेला परेन' : 'Note not found');
                return;
            }
            selectedDate.textContent = note.date;
            entryType.value = note.type;
            noteTitle.value = note.title || '';
            noteTime.value = note.time || '';
            noteDescription.value = note.description || '';
            entryCategory.value = note.category || '';
            recurring.checked = note.recurring || false;
            reminder.checked = note.reminder || false;
            entryCategory.style.display = note.type === 'note' ? 'none' : 'block';
            categoryManager.style.display = note.type === 'note' ? 'none' : 'block';
            saveNote.style.display = 'none';
            editEntry.style.display = 'block';
            noteForm.classList.add('active');
            editingNoteIndex = index;
            noteTitle.focus();
        }

        function updateNote() {
            if (editingNoteIndex === null || !notes[editingNoteIndex]) {
                alert(isNepali ? 'सम्पादन गर्न नोट चयन गरिएको छैन' : 'No note selected for editing');
                return;
            }

            let title = noteTitle.value.trim();
            if (!title) {
                alert(isNepali ? 'शीर्षक / रकम आवश्यक छ' : 'Title / Amount is required');
                return;
            }

            if (entryType.value !== 'note' && (isNaN(parseFloat(title)) || parseFloat(title) <= 0)) {
                alert(isNepali ? 'रकम सकारात्मक संख्या हुनुपर्छ' : 'Amount must be a positive number');
                return;
            }

            let note = notes[editingNoteIndex];
            note.type = entryType.value;
            note.title = title;
            note.time = noteTime.value;
            note.description = noteDescription.value.trim();
            note.category = entryCategory.value;
            note.recurring = recurring.checked;
            note.reminder = reminder.checked;

            try {
                localStorage.setItem('notes', JSON.stringify(notes));
            } catch (e) {
                alert(isNepali ? 'नोट अपडेट गर्न असफल: भण्डारण सीमा नाघ्यो' : 'Failed to update note: Storage limit exceeded');
                return;
            }

            noteForm.classList.remove('active');
            renderCalendar();
            renderNotesList();
            renderFinancialRecords();
            renderMonthlySummary();
            editingNoteIndex = null;
        }

        function deleteNote(index) {
            if (confirm(isNepali ? 'के तपाईं यो नोट मेटाउन चाहनुहुन्छ?' : 'Are you sure you want to delete this note?')) {
                undoStack.push({ action: 'delete', note: { ...notes[index] }, index });
                notes.splice(index, 1);
                try {
                    localStorage.setItem('notes', JSON.stringify(notes));
                } catch (e) {
                    alert(isNepali ? 'नोट मेटाउन असफल: भण्डारण समस्याहरू' : 'Failed to delete note: Storage issues');
                    return;
                }
                renderCalendar();
                renderNotesList();
                renderFinancialRecords();
                renderMonthlySummary();
            }
        }

        function undoLastAction() {
            if (undoStack.length === 0) {
                alert(isNepali ? 'पुर्ववत गर्न कुनै कार्य छैन' : 'No actions to undo');
                return;
            }
            let lastAction = undoStack.pop();
            if (lastAction.action === 'delete') {
                notes.splice(lastAction.index, 0, lastAction.note);
                try {
                    localStorage.setItem('notes', JSON.stringify(notes));
                } catch (e) {
                    alert(isNepali ? 'पुर्ववत असफल: भण्डारण समस्याहरू' : 'Undo failed: Storage issues');
                    return;
                }
                renderCalendar();
                renderNotesList();
                renderFinancialRecords();
                renderMonthlySummary();
            }
        }

        function populateCategories() {
            entryCategory.innerHTML = `
                <option value="" data-en="Select Category" data-ne="श्रेणी चयन गर्नुहोस्">${isNepali ? 'श्रेणी चयन गर्नुहोस्' : 'Select Category'}</option>
                <option value="Food" data-en="Food" data-ne="खाना">${isNepali ? 'खाना' : 'Food'}</option>
                <option value="Salary" data-en="Salary" data-ne="तलब">${isNepali ? 'तलब' : 'Salary'}</option>
                <option value="Rent" data-en="Rent" data-ne="भाडा">${isNepali ? 'भाडा' : 'Rent'}</option>
                <option value="Utilities" data-en="Utilities" data-ne="उपयोगिताहरू">${isNepali ? 'उपयोगिताहरू' : 'Utilities'}</option>
                <option value="Transport" data-en="Transport" data-ne="यातायात">${isNepali ? 'यातायात' : 'Transport'}</option>
                <option value="Entertainment" data-en="Entertainment" data-ne="मनोरञ्जन">${isNepali ? 'मनोरञ्जन' : 'Entertainment'}</option>
                <option value="Freelance" data-en="Freelance" data-ne="फ्रीलान्स">${isNepali ? 'फ्रीलान्स' : 'Freelance'}</option>
                <option value="Other" data-en="Other" data-ne="अन्य">${isNepali ? 'अन्य' : 'Other'}</option>
            `;
            customCategories.forEach(cat => {
                let option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                entryCategory.appendChild(option);
            });
        }

        function addCustomCategory() {
            let category = newCategory.value.trim();
            if (!category) {
                alert(isNepali ? 'श्रेणी नाम आवश्यक छ' : 'Category name is required');
                return;
            }
            if (customCategories.includes(category)) {
                alert(isNepali ? 'श्रेणी पहिले नै अवस्थित छ' : 'Category already exists');
                return;
            }
            customCategories.push(category);
            try {
                localStorage.setItem('customCategories', JSON.stringify(customCategories));
            } catch (e) {
                alert(isNepali ? 'श्रेणी बचत गर्न असफल' : 'Failed to save category');
                return;
            }
            populateCategories();
            entryCategory.value = category;
            newCategory.value = '';
        }

        function renderNotesList() {
            const fragment = document.createDocumentFragment();
            let searchQuery = noteSearch.value.toLowerCase();
            let filteredNotes = notes.filter(note => note.type === 'note' && (
                note.title.toLowerCase().includes(searchQuery) ||
                note.description.toLowerCase().includes(searchQuery)
            ));
            if (monthFilter.value !== 'all') {
                filteredNotes = filteredNotes.filter(note => getRecurringDates(note).some(d => d.startsWith(monthFilter.value)));
            }
            if (filteredNotes.length === 0) {
                let p = document.createElement('p');
                p.textContent = isNepali ? 'कुनै नोटहरू छैनन्' : 'No notes available';
                fragment.appendChild(p);
            } else {
                filteredNotes.forEach((note, index) => {
                    let globalIndex = notes.findIndex(n => n === note);
                    let noteItem = document.createElement('div');
                    noteItem.classList.add('note-item');
                    noteItem.innerHTML = `
                        <div><strong>${note.date}</strong> - ${note.type === 'note' ? 'Note' : note.type === 'income' ? 'Income' : 'Expense'}: ${note.title} ${note.type !== 'note' ? 'NPR' : ''}</div>
                        <div>${note.description || ''}</div>
                        <div>${note.recurring ? (isNepali ? 'मासिक दोहोरिने' : 'Recurring Monthly') : ''}</div>
                        <div>${note.reminder ? (isNepali ? 'रिमाइन्डर सेट' : 'Reminder Set') : ''}</div>
                        <div class="note-actions">
                            <span class="edit-note" data-en="Edit" data-ne="सम्पादन">${isNepali ? 'सम्पादन' : 'Edit'}</span>
                            <span class="delete-note" data-en="Delete" data-ne="मेटाउन">${isNepali ? 'मेटाउन' : 'Delete'}</span>
                        </div>
                    `;
                    noteItem.querySelector('.edit-note').addEventListener('click', () => editNote(globalIndex));
                    noteItem.querySelector('.delete-note').addEventListener('click', () => deleteNote(globalIndex));
                    fragment.appendChild(noteItem);
                });
            }
            notesList.innerHTML = '';
            notesList.appendChild(fragment);
        }

        function renderFinancialRecords() {
            const fragment = document.createDocumentFragment();
            let searchQuery = financeSearch.value.toLowerCase();
            let filteredNotes = notes.filter(note => (note.type === 'income' || note.type === 'expense') && (
                note.title.toLowerCase().includes(searchQuery) ||
                note.description.toLowerCase().includes(searchQuery) ||
                note.category.toLowerCase().includes(searchQuery)
            ));
            if (filteredNotes.length === 0) {
                let p = document.createElement('p');
                p.textContent = isNepali ? 'कुनै वित्तीय रेकर्डहरू छैनन्' : 'No financial records available';
                fragment.appendChild(p);
            } else {
                let financeList = document.createElement('div');
                financeList.classList.add('finance-list');
                filteredNotes.forEach((note, index) => {
                    let globalIndex = notes.findIndex(n => n === note);
                    let financeItem = document.createElement('div');
                    financeItem.classList.add('finance-item');
                    financeItem.innerHTML = `
                        <div><strong>${note.date}</strong> - ${note.type === 'income' ? (isNepali ? 'आय' : 'Income') : (isNepali ? 'खर्च' : 'Expense')}: ${note.title} NPR</div>
                        <div>${isNepali ? 'विवरण' : 'Description'}: ${note.description || ''}</div>
                        <div>${isNepali ? 'श्रेणी' : 'Category'}: ${note.category || ''}</div>
                        <div>${note.recurring ? (isNepali ? 'मासिक दोहोरिने' : 'Recurring Monthly') : ''}</div>
                        <div>${note.reminder ? (isNepali ? 'रिमाइन्डर सेट' : 'Reminder Set') : ''}</div>
                        <div class="note-actions">
                            <span class="edit-note" data-en="Edit" data-ne="सम्पादन">${isNepali ? 'सम्पादन' : 'Edit'}</span>
                            <span class="delete-note" data-en="Delete" data-ne="मेटाउन">${isNepali ? 'मेटाउन' : 'Delete'}</span>
                        </div>
                    `;
                    financeItem.querySelector('.edit-note').addEventListener('click', () => editNote(globalIndex));
                    financeItem.querySelector('.delete-note').addEventListener('click', () => deleteNote(globalIndex));
                    financeList.appendChild(financeItem);
                });
                fragment.appendChild(financeList);
            }
            reportContent.innerHTML = '';
            reportContent.appendChild(fragment);
        }

        function renderReport(type) {
            reportContent.innerHTML = '';
            let year = parseInt(yearFilter.value);
            let lang = isNepali ? 'ne' : 'en';
            let headers = {
                en: { period: 'Period', income: 'Income (NPR)', expense: 'Expense (NPR)', balance: 'Balance (NPR)', day: 'Day', dailySummary: 'Daily Summary', noData: 'No financial data available for this period' },
                ne: { period: 'अवधि', income: 'आय (NPR)', expense: 'खर्च (NPR)', balance: 'ब्यालेन्स (NPR)', day: 'दिन', dailySummary: 'दैनिक सारांश', noData: 'यस अवधिको लागि कुनै वित्तीय डेटा उपलब्ध छैन' }
            };

            if (type === 'records') {
                renderFinancialRecords();
                return;
            }

            if (type === 'weekly') {
                let weeks = {};
                let filteredNotes = notes.filter(note => getRecurringDates(note).some(d => d.startsWith(year.toString())) && (note.type === 'income' || note.type === 'expense'));
                if (filteredNotes.length === 0) {
                    reportContent.innerHTML = `<p>${headers[lang].noData}</p>`;
                    return;
                }

               
    filteredNotes.forEach(note => {
        getRecurringDates(note).forEach(date => {
            if (!date.startsWith(year.toString())) return;
            let [y, m, d] = date.split('-').map(Number);
            let monthIndex = m - 1;
            let day = parseInt(d);
            let weekNumber = Math.ceil(day / 7);
            let weekKey = `${y}-${m}-${weekNumber}`;
            if (!weeks[weekKey]) {
                weeks[weekKey] = { income: 0, expense: 0, daily: {} };
            }
            if (note.type === 'income') {
                weeks[weekKey].income += parseFloat(note.title || 0);
            } else {
                weeks[weekKey].expense += parseFloat(note.title || 0);
            }
            let dayKey = `${y}-${m}-${d}`;
            if (!weeks[weekKey].daily[dayKey]) {
                weeks[weekKey].daily[dayKey] = { income: 0, expense: 0 };
            }
            if (note.type === 'income') {
                weeks[weekKey].daily[dayKey].income += parseFloat(note.title || 0);
            } else {
                weeks[weekKey].daily[dayKey].expense += parseFloat(note.title || 0);
            }
        });
    });

    let table = document.createElement('table');
    table.classList.add('report-table');
    table.setAttribute('role', 'grid');
    table.innerHTML = `
        <tr>
            <th>${headers[lang].period}</th>
            <th>${headers[lang].income}</th>
            <th>${headers[lang].expense}</th>
            <th>${headers[lang].balance}</th>
            <th>${headers[lang].dailySummary}</th>
        </tr>
    `;
    let totalIncome = 0, totalExpense = 0;
    for (let weekKey in weeks) {
        let [y, m, w] = weekKey.split('-').map(Number);
        let monthName = isNepali ? monthsNepali[m - 1] : calendarData[y][m - 1].name;
        let income = weeks[weekKey].income;
        let expense = weeks[weekKey].expense;
        totalIncome += income;
        totalExpense += expense;
        let dailySummary = '';
        for (let dayKey in weeks[weekKey].daily) {
            let [dy, dm, dd] = dayKey.split('-').map(Number);
            dailySummary += `${headers[lang].day} ${dd}: ${isNepali ? 'आय' : 'Income'}: ${weeks[weekKey].daily[dayKey].income} NPR, ${isNepali ? 'खर्च' : 'Expense'}: ${weeks[weekKey].daily[dayKey].expense} NPR<br>`;
        }
        table.innerHTML += `
            <tr>
                <td>${monthName} ${isNepali ? 'हप्ता' : 'Week'} ${w}</td>
                <td>${income}</td>
                <td>${expense}</td>
                <td>${income - expense}</td>
                <td>${dailySummary}</td>
            </tr>
        `;
    }
    table.innerHTML += `
        <tr>
            <td>${isNepali ? 'कुल' : 'Total'}</td>
            <td>${totalIncome}</td>
            <td>${totalExpense}</td>
            <td>${totalIncome - totalExpense}</td>
            <td></td>
        </tr>
    `;
    reportContent.appendChild(table);
} else if (type === 'monthly') {
    let months = {};
    let filteredNotes = notes.filter(note => getRecurringDates(note).some(d => d.startsWith(year.toString())) && (note.type === 'income' || note.type === 'expense'));
    if (filteredNotes.length === 0) {
        reportContent.innerHTML = `<p>${headers[lang].noData}</p>`;
        return;
    }

    filteredNotes.forEach(note => {
        getRecurringDates(note).forEach(date => {
            if (!date.startsWith(year.toString())) return;
            let [y, m] = date.split('-').map(Number);
            let monthKey = `${y}-${m}`;
            if (!months[monthKey]) {
                months[monthKey] = { income: 0, expense: 0 };
            }
            if (note.type === 'income') {
                months[monthKey].income += parseFloat(note.title || 0);
            } else {
                months[monthKey].expense += parseFloat(note.title || 0);
            }
        });
    });

    let table = document.createElement('table');
    table.classList.add('report-table');
    table.setAttribute('role', 'grid');
    table.innerHTML = `
        <tr>
            <th>${headers[lang].period}</th>
            <th>${headers[lang].income}</th>
            <th>${headers[lang].expense}</th>
            <th>${headers[lang].balance}</th>
        </tr>
    `;
    let chartData = { labels: [], income: [], expense: [] };
    let totalIncome = 0, totalExpense = 0;
    for (let monthKey in months) {
        let [y, m] = monthKey.split('-').map(Number);
        let monthName = isNepali ? monthsNepali[m - 1] : calendarData[y][m - 1].name;
        let income = months[monthKey].income;
        let expense = months[monthKey].expense;
        totalIncome += income;
        totalExpense += expense;
        chartData.labels.push(monthName);
        chartData.income.push(income);
        chartData.expense.push(expense);
        table.innerHTML += `
            <tr>
                <td>${monthName} ${y}</td>
                <td>${income}</td>
                <td>${expense}</td>
                <td>${income - expense}</td>
            </tr>
        `;
    }
    table.innerHTML += `
        <tr>
            <td>${isNepali ? 'कुल' : 'Total'}</td>
            <td>${totalIncome}</td>
            <td>${totalExpense}</td>
            <td>${totalIncome - totalExpense}</td>
        </tr>
    `;
    reportContent.appendChild(table);

    let canvas = document.createElement('canvas');
    canvas.id = 'financeChart';
    canvas.setAttribute('aria-label', isNepali ? 'मासिक वित्त सारांश चार्ट' : 'Monthly Finance Summary Chart');
    reportContent.appendChild(canvas);
    new Chart(canvas, {
        type: 'pie',
        data: {
            labels: chartData.labels,
            datasets: [
                {
                    label: isNepali ? 'आय' : 'Income',
                    data: chartData.income,
                    backgroundColor: '#4caf50'
                },
                {
                    label: isNepali ? 'खर्च' : 'Expense',
                    data: chartData.expense,
                    backgroundColor: '#d32f2f'
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: isNepali ? 'मासिक वित्त सारांश' : 'Monthly Finance Summary' }
            }
        }
    });
} else if (type === 'yearly') {
    let years = {};
    let filteredNotes = notes.filter(note => (note.type === 'income' || note.type === 'expense'));
    if (filteredNotes.length === 0) {
        reportContent.innerHTML = `<p>${headers[lang].noData}</p>`;
        return;
    }

    filteredNotes.forEach(note => {
        getRecurringDates(note).forEach(date => {
            let [y] = date.split('-').map(Number);
            if (!years[y]) {
                years[y] = { income: 0, expense: 0 };
            }
            if (note.type === 'income') {
                years[y].income += parseFloat(note.title || 0);
            } else {
                years[y].expense += parseFloat(note.title || 0);
            }
        });
    });

    let table = document.createElement('table');
    table.classList.add('report-table');
    table.setAttribute('role', 'grid');
    table.innerHTML = `
        <tr>
            <th>${headers[lang].period}</th>
            <th>${headers[lang].income}</th>
            <th>${headers[lang].expense}</th>
            <th>${headers[lang].balance}</th>
        </tr>
    `;
    let totalIncome = 0, totalExpense = 0;
    for (let year in years) {
        let income = years[year].income;
        let expense = years[year].expense;
        totalIncome += income;
        totalExpense += expense;
        table.innerHTML += `
            <tr>
                <td>${year} BS</td>
                <td>${income}</td>
                <td>${expense}</td>
                <td>${income - expense}</td>
            </tr>
        `;
    }
    table.innerHTML += `
        <tr>
            <td>${isNepali ? 'कुल' : 'Total'}</td>
            <td>${totalIncome}</td>
            <td>${totalExpense}</td>
            <td>${totalIncome - totalExpense}</td>
        </tr>
    `;
    reportContent.appendChild(table);
}
}

function exportToExcel(type) {
let data = [];
let headers = [];
if (type === 'note') {
    headers = isNepali 
        ? ['मिति', 'प्रकार', 'शीर्षक', 'विवरण', 'समय', 'दोहोरिने', 'रिमाइन्डर']
        : ['Date', 'Type', 'Title', 'Description', 'Time', 'Recurring', 'Reminder'];
    data = notes.filter(note => note.type === 'note').map(note => ({
        Date: note.date,
        Type: note.type,
        Title: note.title,
        Description: note.description || '',
        Time: note.time || '',
        Recurring: note.recurring ? (isNepali ? 'हो' : 'Yes') : (isNepali ? 'होइन' : 'No'),
        Reminder: note.reminder ? (isNepali ? 'हो' : 'Yes') : (isNepali ? 'होइन' : 'No')
    }));
} else if (type === 'finance') {
    headers = isNepali 
        ? ['मिति', 'प्रकार', 'रकम', 'विवरण', 'श्रेणी', 'समय', 'दोहोरिने', 'रिमाइन्डर']
        : ['Date', 'Type', 'Amount', 'Description', 'Category', 'Time', 'Recurring', 'Reminder'];
    data = notes.filter(note => note.type === 'income' || note.type === 'expense').map(note => ({
        Date: note.date,
        Type: note.type === 'income' ? (isNepali ? 'आय' : 'Income') : (isNepali ? 'खर्च' : 'Expense'),
        Amount: note.title,
        Description: note.description || '',
        Category: note.category || '',
        Time: note.time || '',
        Recurring: note.recurring ? (isNepali ? 'हो' : 'Yes') : (isNepali ? 'होइन' : 'No'),
        Reminder: note.reminder ? (isNepali ? 'हो' : 'Yes') : (isNepali ? 'होइन' : 'No')
    }));
} else if (type === 'calendar') {
    headers = isNepali 
        ? ['महिना', 'दिन', 'ग्रेगोरियन मिति', 'बिदा']
        : ['Month', 'Day', 'Gregorian Date', 'Holiday'];
    Object.keys(calendarData).forEach(year => {
        calendarData[year].forEach((month, monthIndex) => {
            for (let day = 1; day <= month.days; day++) {
                let gregDate = getGregorianDate(parseInt(year), monthIndex, day);
                let holiday = holidays[year]?.find(h => h.month === monthIndex && h.day === day);
                data.push({
                    Month: isNepali ? monthsNepali[monthIndex] : month.name,
                    Day: day,
                    'Gregorian Date': gregDate.toLocaleDateString('en-US'),
                    Holiday: holiday ? (isNepali ? holiday.nepali : holiday.name) : ''
                });
            }
        });
    });
}
if (data.length === 0) {
    alert(isNepali ? 'निर्यात गर्न डेटा छैन' : 'No data to export');
    return;
}
let ws = XLSX.utils.json_to_sheet(data, { header: headers });
let wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
XLSX.write(wb, `${type}_${currentYear}_${isNepali ? 'ne' : 'en'}.xlsx`);
}

function exportToPDF(type) {
const { jsPDF } = window.jspdf;
const doc = new jsPDF();
doc.setFontSize(12);
doc.text(isNepali ? `नेपाली पात्रो ${currentYear}` : `Nepali Calendar ${currentYear}`, 10, 10);
let y = 20;
if (type === 'note') {
    doc.text(isNepali ? 'नोटहरू' : 'Notes', 10, y);
    y += 10;
    notes.filter(note => note.type === 'note').forEach(note => {
        doc.text(`${note.date} - ${note.title}: ${note.description || ''} ${note.recurring ? '(Recurring)' : ''} ${note.reminder ? '(Reminder)' : ''}`, 10, y);
        y += 10;
        if (y > 270) {
            doc.addPage();
            y = 10;
        }
    });
} else if (type === 'finance') {
    doc.text(isNepali ? 'वित्त' : 'Finances', 10, y);
    y += 10;
    notes.filter(note => note.type === 'income' || note.type === 'expense').forEach(note => {
        doc.text(`${note.date} - ${note.type === 'income' ? (isNepali ? 'आय' : 'Income') : (isNepali ? 'खर्च' : 'Expense')}: ${note.title} NPR, ${isNepali ? 'श्रेणी' : 'Category'}: ${note.category || ''} ${note.recurring ? '(Recurring)' : ''} ${note.reminder ? '(Reminder)' : ''}`, 10, y);
        y += 10;
        if (y > 270) {
            doc.addPage();
            y = 10;
        }
    });
} else if (type === 'calendar') {
    doc.text(isNepali ? 'मासिक पात्रो' : 'Monthly Calendar', 10, y);
    y += 10;
    Object.keys(calendarData).forEach(year => {
        calendarData[year].forEach((month, monthIndex) => {
            doc.text(`${isNepali ? monthsNepali[monthIndex] : month.name} ${year}`, 10, y);
            y += 10;
            for (let day = 1; day <= month.days; day++) {
                let gregDate = getGregorianDate(parseInt(year), monthIndex, day);
                let holiday = holidays[year]?.find(h => h.month === monthIndex && h.day === day);
                doc.text(`${day} (${gregDate.toLocaleDateString('en-US')})${holiday ? ': ' + (isNepali ? holiday.nepali : holiday.name) : ''}`, 10, y);
                y += 10;
                if (y > 270) {
                    doc.addPage();
                    y = 10;
                }
            }
        });
    });
}
doc.save(`${type}_${currentYear}_${isNepali ? 'ne' : 'en'}.pdf`);
}

function backupDataFunc() {
try {
    let data = JSON.stringify(notes);
    let blob = new Blob([data], { type: 'application/json' });
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = `backup_${currentYear}_${isNepali ? 'ne' : 'en'}.json`;
    a.click();
    URL.revokeObjectURL(url);
} catch (e) {
    alert(isNepali ? 'ब्याकअप असफल' : 'Backup failed');
}
}

function importData(event, type) {
const file = event.target.files[0];
if (!file) return;
const reader = new FileReader();
reader.onload = function(e) {
    try {
        const importedData = JSON.parse(e.target.result);
        if (!Array.isArray(importedData)) throw new Error('Invalid data format');
        if (type === 'note') {
            notes = notes.concat(importedData.filter(item => item.type === 'note'));
        } else if (type === 'finance') {
            notes = notes.concat(importedData.filter(item => item.type === 'income' || item.type === 'expense'));
        }
        localStorage.setItem('notes', JSON.stringify(notes));
        renderCalendar();
        renderNotesList();
        renderFinancialRecords();
        renderMonthlySummary();
        alert(isNepali ? 'डेटा सफलतापूर्वक आयात गरियो' : 'Data imported successfully');
    } catch (err) {
        console.error('Import error:', err);
        alert(isNepali ? 'आयात असफल: अमान्य फाइल' : 'Import failed: Invalid file');
    }
};
reader.readAsText(file);
}

// Event listeners
prevMonth.addEventListener('click', () => {
if (currentMonthIndex === 0) {
    currentYear--;
    currentMonthIndex = 11;
} else {
    currentMonthIndex--;
}
renderCalendar();
renderMonthTabs();
});

nextMonth.addEventListener('click', () => {
if (currentMonthIndex === 11) {
    currentYear++;
    currentMonthIndex = 0;
} else {
    currentMonthIndex++;
}
renderCalendar();
renderMonthTabs();
});

yearFilter.addEventListener('change', () => {
currentYear = parseInt(yearFilter.value);
currentMonthIndex = 0;
renderCalendar();
renderMonthTabs();
});

todayButton.addEventListener('click', () => {
let today = new Date();
let bsDate = getBSDateFromGregorian(today);
if (bsDate) {
    currentYear = bsDate.year;
    currentMonthIndex = bsDate.month;
    yearFilter.value = currentYear;
    renderCalendar();
    renderMonthTabs();
}
});

viewNotes.addEventListener('click', () => {
notesModal.style.display = 'block';
renderNotesList();
});

viewFinance.addEventListener('click', () => {
reportModal.style.display = 'block';
renderReport('records');
});

backupData.addEventListener('click', backupDataFunc);

restoreData.addEventListener('click', () => {
restoreFileInput.click();
});

restoreFileInput.addEventListener('change', (e) => importData(e, 'note'));

languageToggle.addEventListener('click', toggleLanguage);

entryType.addEventListener('change', () => {
if (entryType.value === 'note') {
    entryCategory.style.display = 'none';
    categoryManager.style.display = 'none';
} else {
    entryCategory.style.display = 'block';
    categoryManager.style.display = 'block';
}
});

saveNote.addEventListener('click', saveEntry);
editEntry.addEventListener('click', updateNote);
closeEntry.addEventListener('click', () => {
noteForm.classList.remove('active');
editingNoteIndex = null;
});
addCategory.addEventListener('click', addCustomCategory);

closeModal.addEventListener('click', () => {
notesModal.style.display = 'none';
});

closeReportModal.addEventListener('click', () => {
reportModal.style.display = 'none';
});

monthFilter.addEventListener('change', renderNotesList);

noteSearch.addEventListener('input', debounce(renderNotesList, 300));
financeSearch.addEventListener('input', debounce(renderFinancialRecords, 300));

clearNotes.addEventListener('click', () => {
if (confirm(isNepali ? 'के तपाईं सबै नोटहरू मेटाउन चाहनुहुन्छ?' : 'Are you sure you want to clear all notes?')) {
    undoStack.push({ action: 'clear', notes: [...notes] });
    notes = [];
    localStorage.setItem('notes', JSON.stringify(notes));
    renderCalendar();
    renderNotesList();
    renderFinancialRecords();
    renderMonthlySummary();
}
});

weeklyReportTab.addEventListener('click', () => {
document.querySelectorAll('.report-tab').forEach(tab => {
    tab.classList.remove('active');
    tab.setAttribute('aria-selected', 'false');
});
weeklyReportTab.classList.add('active');
weeklyReportTab.setAttribute('aria-selected', 'true');
renderReport('weekly');
});

monthlyReportTab.addEventListener('click', () => {
document.querySelectorAll('.report-tab').forEach(tab => {
    tab.classList.remove('active');
    tab.setAttribute('aria-selected', 'false');
});
monthlyReportTab.classList.add('active');
monthlyReportTab.setAttribute('aria-selected', 'true');
renderReport('monthly');
});

yearlyReportTab.addEventListener('click', () => {
document.querySelectorAll('.report-tab').forEach(tab => {
    tab.classList.remove('active');
    tab.setAttribute('aria-selected', 'false');
});
yearlyReportTab.classList.add('active');
yearlyReportTab.setAttribute('aria-selected', 'true');
renderReport('yearly');
});

recordsReportTab.addEventListener('click', () => {
document.querySelectorAll('.report-tab').forEach(tab => {
    tab.classList.remove('active');
    tab.setAttribute('aria-selected', 'false');
});
recordsReportTab.classList.add('active');
recordsReportTab.setAttribute('aria-selected', 'true');
renderReport('records');
});

addNote.addEventListener('click', () => {
let today = new Date();
let bsDate = getBSDateFromGregorian(today);
if (bsDate) {
    selectedDate.textContent = `${bsDate.year}-${String(bsDate.month + 1).padStart(2, '0')}-${String(bsDate.day).padStart(2, '0')}`;
}
entryType.value = 'note';
noteTitle.value = '';
noteTime.value = '';
noteDescription.value = '';
recurring.checked = false;
reminder.checked = false;
entryCategory.style.display = 'none';
categoryManager.style.display = 'none';
saveNote.style.display = 'block';
editEntry.style.display = 'none';
noteForm.classList.add('active');
noteTitle.focus();
});

addFinance.addEventListener('click', () => {
let today = new Date();
let bsDate = getBSDateFromGregorian(today);
if (bsDate) {
    selectedDate.textContent = `${bsDate.year}-${String(bsDate.month + 1).padStart(2, '0')}-${String(bsDate.day).padStart(2, '0')}`;
}
entryType.value = 'income';
noteTitle.value = '';
noteTime.value = '';
noteDescription.value = '';
recurring.checked = false;
reminder.checked = false;
entryCategory.style.display = 'block';
categoryManager.style.display = 'block';
saveNote.style.display = 'block';
editEntry.style.display = 'none';
noteForm.classList.add('active');
noteTitle.focus();
});

undoAction.addEventListener('click', undoLastAction);

document.querySelectorAll('.excel-option').forEach(option => {
option.addEventListener('click', () => {
    exportToExcel(option.dataset.type);
});
});

document.querySelectorAll('.pdf-option').forEach(option => {
option.addEventListener('click', () => {
    exportToPDF(option.dataset.type);
});
});

document.querySelectorAll('.import-option').forEach(option => {
option.addEventListener('click', () => {
    restoreFileInput.value = '';
    restoreFileInput.dataset.importType = option.dataset.type;
    restoreFileInput.click();
});
});

restoreFileInput.addEventListener('change', (e) => {
importData(e, e.target.dataset.importType);
});

// Initialize
function initialize() {
let today = new Date();
let bsDate = getBSDateFromGregorian(today);
if (bsDate) {
    currentYear = bsDate.year;
    currentMonthIndex = bsDate.month;
    yearFilter.value = currentYear;
    todayNepaliDate.textContent = isNepali 
        ? `${bsDate.day} ${monthsNepali[bsDate.month]} ${bsDate.year} BS`
        : `${bsDate.day} ${calendarData[bsDate.year][bsDate.month].name} ${bsDate.year} BS`;
}
todayEnglishDate.textContent = today.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

const fragment = document.createDocumentFragment();
calendarData[currentYear].forEach((month, index) => {
    let option = document.createElement('option');
    option.value = `${currentYear}-${String(index + 1).padStart(2, '0')}`;
    option.textContent = isNepali ? monthsNepali[index] : month.name;
    fragment.appendChild(option);
});
monthFilter.appendChild(fragment);

if ("Notification" in window && Notification.permission !== "granted") {
    Notification.requestPermission();
}

renderMonthTabs();
renderCalendar();
renderNotesList();
populateCategories();
checkReminders();
}

initialize();
</script>
</body>
</html>
